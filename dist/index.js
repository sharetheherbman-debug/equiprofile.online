var gn=Object.defineProperty;var vr=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,r)=>(typeof require<"u"?require:e)[r]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')});var gt=(t,e)=>()=>(t&&(e=t(t=0)),e);var yn=(t,e)=>{for(var r in e)gn(t,r,{get:e[r],enumerable:!0})};import{int as i,mysqlEnum as _,mysqlTable as A,text as w,timestamp as p,varchar as c,boolean as k,date as V}from"drizzle-orm/mysql-core";var O,D,E,x,K,te,pe,Ne,ae,J,we,ve,me,$,Tr,X,Hs,yt,Re,xe,Fs,Y,Ms,Te,De,je,Ks,j,Dr,Le,_r,T,be,Ws,P,z,v,Vs,Ke=gt(()=>{"use strict";O=A("users",{id:i("id").autoincrement().primaryKey(),openId:c("openId",{length:64}).notNull().unique(),name:w("name"),email:c("email",{length:320}),passwordHash:c("passwordHash",{length:255}),emailVerified:k("emailVerified").default(!1),resetToken:c("resetToken",{length:255}),resetTokenExpiry:p("resetTokenExpiry"),loginMethod:c("loginMethod",{length:64}),role:_("role",["user","admin"]).default("user").notNull(),subscriptionStatus:_("subscriptionStatus",["trial","active","cancelled","overdue","expired"]).default("trial").notNull(),subscriptionPlan:_("subscriptionPlan",["monthly","yearly"]).default("monthly"),stripeCustomerId:c("stripeCustomerId",{length:255}),stripeSubscriptionId:c("stripeSubscriptionId",{length:255}),trialEndsAt:p("trialEndsAt"),subscriptionEndsAt:p("subscriptionEndsAt"),lastPaymentAt:p("lastPaymentAt"),isActive:k("isActive").default(!0).notNull(),isSuspended:k("isSuspended").default(!1).notNull(),suspendedReason:w("suspendedReason"),phone:c("phone",{length:20}),location:c("location",{length:255}),profileImageUrl:w("profileImageUrl"),preferences:w("preferences"),language:c("language",{length:10}).default("en"),theme:_("theme",["light","dark","system"]).default("system"),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull(),lastSignedIn:p("lastSignedIn").defaultNow().notNull()}),D=A("horses",{id:i("id").autoincrement().primaryKey(),userId:i("userId").notNull(),name:c("name",{length:100}).notNull(),breed:c("breed",{length:100}),age:i("age"),dateOfBirth:V("dateOfBirth"),height:i("height"),weight:i("weight"),color:c("color",{length:50}),gender:_("gender",["stallion","mare","gelding"]),discipline:c("discipline",{length:100}),level:c("level",{length:50}),registrationNumber:c("registrationNumber",{length:100}),microchipNumber:c("microchipNumber",{length:100}),notes:w("notes"),photoUrl:w("photoUrl"),isActive:k("isActive").default(!0).notNull(),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),E=A("healthRecords",{id:i("id").autoincrement().primaryKey(),horseId:i("horseId").notNull(),userId:i("userId").notNull(),recordType:_("recordType",["vaccination","deworming","dental","farrier","veterinary","injury","medication","other"]).notNull(),title:c("title",{length:200}).notNull(),description:w("description"),recordDate:V("recordDate").notNull(),nextDueDate:V("nextDueDate"),vetName:c("vetName",{length:100}),vetPhone:c("vetPhone",{length:20}),vetClinic:c("vetClinic",{length:200}),cost:i("cost"),documentUrl:w("documentUrl"),notes:w("notes"),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),x=A("trainingSessions",{id:i("id").autoincrement().primaryKey(),horseId:i("horseId").notNull(),userId:i("userId").notNull(),sessionDate:V("sessionDate").notNull(),startTime:c("startTime",{length:10}),endTime:c("endTime",{length:10}),duration:i("duration"),sessionType:_("sessionType",["flatwork","jumping","hacking","lunging","groundwork","competition","lesson","other"]).notNull(),discipline:c("discipline",{length:100}),trainer:c("trainer",{length:100}),location:c("location",{length:200}),goals:w("goals"),exercises:w("exercises"),notes:w("notes"),performance:_("performance",["excellent","good","average","poor"]),weather:c("weather",{length:100}),temperature:i("temperature"),isCompleted:k("isCompleted").default(!1).notNull(),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),K=A("feedingPlans",{id:i("id").autoincrement().primaryKey(),horseId:i("horseId").notNull(),userId:i("userId").notNull(),feedType:c("feedType",{length:100}).notNull(),brandName:c("brandName",{length:100}),quantity:c("quantity",{length:50}).notNull(),unit:c("unit",{length:20}),mealTime:_("mealTime",["morning","midday","evening","night"]).notNull(),frequency:c("frequency",{length:50}).default("daily"),specialInstructions:w("specialInstructions"),isActive:k("isActive").default(!0).notNull(),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),te=A("documents",{id:i("id").autoincrement().primaryKey(),userId:i("userId").notNull(),horseId:i("horseId"),healthRecordId:i("healthRecordId"),fileName:c("fileName",{length:255}).notNull(),fileType:c("fileType",{length:50}).notNull(),fileSize:i("fileSize"),fileUrl:w("fileUrl").notNull(),fileKey:c("fileKey",{length:500}).notNull(),category:_("category",["health","registration","insurance","competition","other"]).default("other"),description:w("description"),createdAt:p("createdAt").defaultNow().notNull()}),pe=A("weatherLogs",{id:i("id").autoincrement().primaryKey(),userId:i("userId").notNull(),location:c("location",{length:255}).notNull(),temperature:i("temperature"),humidity:i("humidity"),windSpeed:i("windSpeed"),precipitation:i("precipitation"),conditions:c("conditions",{length:100}),uvIndex:i("uvIndex"),visibility:i("visibility"),ridingRecommendation:_("ridingRecommendation",["excellent","good","fair","poor","not_recommended"]),aiAnalysis:w("aiAnalysis"),checkedAt:p("checkedAt").defaultNow().notNull()}),Ne=A("systemSettings",{id:i("id").autoincrement().primaryKey(),settingKey:c("settingKey",{length:100}).notNull().unique(),settingValue:w("settingValue"),settingType:_("settingType",["string","number","boolean","json"]).default("string"),description:w("description"),isEncrypted:k("isEncrypted").default(!1),updatedBy:i("updatedBy"),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),ae=A("adminSessions",{id:i("id").autoincrement().primaryKey(),userId:i("userId").notNull(),expiresAt:p("expiresAt").notNull(),createdAt:p("createdAt").defaultNow().notNull()}),J=A("adminUnlockAttempts",{id:i("id").autoincrement().primaryKey(),userId:i("userId").notNull().unique(),attempts:i("attempts").default(0).notNull(),lockedUntil:p("lockedUntil"),lastAttemptAt:p("lastAttemptAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),we=A("activityLogs",{id:i("id").autoincrement().primaryKey(),userId:i("userId"),action:c("action",{length:100}).notNull(),entityType:c("entityType",{length:50}),entityId:i("entityId"),details:w("details"),ipAddress:c("ipAddress",{length:45}),userAgent:w("userAgent"),createdAt:p("createdAt").defaultNow().notNull()}),ve=A("backupLogs",{id:i("id").autoincrement().primaryKey(),backupType:_("backupType",["full","incremental","users","horses"]).notNull(),status:_("status",["pending","running","completed","failed"]).notNull(),fileName:c("fileName",{length:255}),fileSize:i("fileSize"),fileUrl:w("fileUrl"),errorMessage:w("errorMessage"),startedAt:p("startedAt").defaultNow().notNull(),completedAt:p("completedAt")}),me=A("stables",{id:i("id").autoincrement().primaryKey(),name:c("name",{length:200}).notNull(),description:w("description"),ownerId:i("ownerId").notNull(),location:c("location",{length:255}),logo:w("logo"),primaryColor:c("primaryColor",{length:7}),secondaryColor:c("secondaryColor",{length:7}),customDomain:c("customDomain",{length:255}),branding:w("branding"),isActive:k("isActive").default(!0).notNull(),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),$=A("stableMembers",{id:i("id").autoincrement().primaryKey(),stableId:i("stableId").notNull(),userId:i("userId").notNull(),role:_("role",["owner","admin","trainer","member","viewer"]).notNull(),permissions:w("permissions"),isActive:k("isActive").default(!0).notNull(),joinedAt:p("joinedAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),Tr=A("stableInvites",{id:i("id").autoincrement().primaryKey(),stableId:i("stableId").notNull(),invitedByUserId:i("invitedByUserId").notNull(),email:c("email",{length:320}).notNull(),role:_("role",["admin","trainer","member","viewer"]).notNull(),token:c("token",{length:100}).notNull().unique(),status:_("status",["pending","accepted","declined","expired"]).default("pending").notNull(),expiresAt:p("expiresAt").notNull(),acceptedAt:p("acceptedAt"),createdAt:p("createdAt").defaultNow().notNull()}),X=A("events",{id:i("id").autoincrement().primaryKey(),userId:i("userId").notNull(),stableId:i("stableId"),horseId:i("horseId"),title:c("title",{length:200}).notNull(),description:w("description"),eventType:_("eventType",["training","competition","veterinary","farrier","lesson","meeting","other"]).notNull(),startDate:p("startDate").notNull(),endDate:p("endDate"),location:c("location",{length:255}),isAllDay:k("isAllDay").default(!1).notNull(),isRecurring:k("isRecurring").default(!1).notNull(),recurrenceRule:w("recurrenceRule"),color:c("color",{length:7}),isCompleted:k("isCompleted").default(!1).notNull(),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),Hs=A("eventReminders",{id:i("id").autoincrement().primaryKey(),eventId:i("eventId").notNull(),userId:i("userId").notNull(),reminderTime:p("reminderTime").notNull(),reminderType:_("reminderType",["email","push","sms"]).notNull(),isSent:k("isSent").default(!1).notNull(),sentAt:p("sentAt"),createdAt:p("createdAt").defaultNow().notNull()}),yt=A("feedCosts",{id:i("id").autoincrement().primaryKey(),userId:i("userId").notNull(),horseId:i("horseId"),feedType:c("feedType",{length:100}).notNull(),brandName:c("brandName",{length:100}),quantity:c("quantity",{length:50}).notNull(),unit:c("unit",{length:20}),costPerUnit:i("costPerUnit").notNull(),purchaseDate:V("purchaseDate").notNull(),supplier:c("supplier",{length:200}),notes:w("notes"),createdAt:p("createdAt").defaultNow().notNull()}),Re=A("vaccinations",{id:i("id").autoincrement().primaryKey(),horseId:i("horseId").notNull(),userId:i("userId").notNull(),vaccineName:c("vaccineName",{length:200}).notNull(),vaccineType:c("vaccineType",{length:100}),dateAdministered:V("dateAdministered").notNull(),nextDueDate:V("nextDueDate"),batchNumber:c("batchNumber",{length:100}),vetName:c("vetName",{length:100}),vetClinic:c("vetClinic",{length:200}),cost:i("cost"),notes:w("notes"),documentUrl:w("documentUrl"),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),xe=A("dewormings",{id:i("id").autoincrement().primaryKey(),horseId:i("horseId").notNull(),userId:i("userId").notNull(),productName:c("productName",{length:200}).notNull(),activeIngredient:c("activeIngredient",{length:200}),dateAdministered:V("dateAdministered").notNull(),nextDueDate:V("nextDueDate"),dosage:c("dosage",{length:100}),weight:i("weight"),cost:i("cost"),notes:w("notes"),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),Fs=A("shareLinks",{id:i("id").autoincrement().primaryKey(),userId:i("userId").notNull(),horseId:i("horseId"),linkType:_("linkType",["horse","stable","medical_passport"]).notNull(),token:c("token",{length:100}).notNull().unique(),isPublic:k("isPublic").default(!1).notNull(),isActive:k("isActive").default(!0).notNull(),expiresAt:p("expiresAt"),viewCount:i("viewCount").default(0).notNull(),lastViewedAt:p("lastViewedAt"),settings:w("settings"),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),Y=A("competitions",{id:i("id").autoincrement().primaryKey(),userId:i("userId").notNull(),horseId:i("horseId").notNull(),competitionName:c("competitionName",{length:200}).notNull(),venue:c("venue",{length:200}),date:V("date").notNull(),discipline:c("discipline",{length:100}),level:c("level",{length:50}),class:c("class",{length:100}),placement:c("placement",{length:50}),score:c("score",{length:50}),notes:w("notes"),cost:i("cost"),winnings:i("winnings"),documentUrl:w("documentUrl"),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),Ms=A("documentTags",{id:i("id").autoincrement().primaryKey(),documentId:i("documentId").notNull(),tag:c("tag",{length:50}).notNull(),createdAt:p("createdAt").defaultNow().notNull()}),Te=A("stripeEvents",{id:i("id").autoincrement().primaryKey(),eventId:c("eventId",{length:255}).notNull().unique(),eventType:c("eventType",{length:100}).notNull(),processed:k("processed").default(!1).notNull(),payload:w("payload"),error:w("error"),createdAt:p("createdAt").defaultNow().notNull(),processedAt:p("processedAt")}),De=A("messageThreads",{id:i("id").autoincrement().primaryKey(),stableId:i("stableId").notNull(),title:c("title",{length:200}),isActive:k("isActive").default(!0).notNull(),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),je=A("messages",{id:i("id").autoincrement().primaryKey(),threadId:i("threadId").notNull(),senderId:i("senderId").notNull(),content:w("content").notNull(),attachments:w("attachments"),isRead:k("isRead").default(!1).notNull(),createdAt:p("createdAt").defaultNow().notNull()}),Ks=A("competitionResults",{id:i("id").autoincrement().primaryKey(),competitionId:i("competitionId").notNull(),userId:i("userId").notNull(),horseId:i("horseId").notNull(),roundNumber:i("roundNumber").default(1),score:c("score",{length:50}),penalties:i("penalties"),time:c("time",{length:20}),judgeScores:w("judgeScores"),technicalScore:i("technicalScore"),artisticScore:i("artisticScore"),notes:w("notes"),createdAt:p("createdAt").defaultNow().notNull()}),j=A("trainingProgramTemplates",{id:i("id").autoincrement().primaryKey(),userId:i("userId").notNull(),stableId:i("stableId"),name:c("name",{length:200}).notNull(),description:w("description"),duration:i("duration"),discipline:c("discipline",{length:100}),level:c("level",{length:50}),goals:w("goals"),programData:w("programData").notNull(),isPublic:k("isPublic").default(!1).notNull(),isActive:k("isActive").default(!0).notNull(),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),Dr=A("trainingPrograms",{id:i("id").autoincrement().primaryKey(),horseId:i("horseId").notNull(),userId:i("userId").notNull(),templateId:i("templateId"),name:c("name",{length:200}).notNull(),startDate:V("startDate").notNull(),endDate:V("endDate"),status:_("status",["active","completed","paused","cancelled"]).default("active").notNull(),progress:i("progress").default(0),programData:w("programData").notNull(),notes:w("notes"),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),Le=A("reports",{id:i("id").autoincrement().primaryKey(),userId:i("userId").notNull(),stableId:i("stableId"),horseId:i("horseId"),reportType:_("reportType",["monthly_summary","health_report","training_progress","cost_analysis","competition_summary"]).notNull(),title:c("title",{length:200}).notNull(),reportData:w("reportData").notNull(),fileUrl:w("fileUrl"),generatedAt:p("generatedAt").defaultNow().notNull()}),_r=A("reportSchedules",{id:i("id").autoincrement().primaryKey(),userId:i("userId").notNull(),stableId:i("stableId"),reportType:_("reportType",["monthly_summary","health_report","training_progress","cost_analysis","competition_summary"]).notNull(),frequency:_("frequency",["daily","weekly","monthly","quarterly"]).notNull(),recipients:w("recipients"),isActive:k("isActive").default(!0).notNull(),lastRunAt:p("lastRunAt"),nextRunAt:p("nextRunAt"),createdAt:p("createdAt").defaultNow().notNull()}),T=A("breeding",{id:i("id").autoincrement().primaryKey(),mareId:i("mareId").notNull(),stallionId:i("stallionId"),stallionName:c("stallionName",{length:200}),breedingDate:V("breedingDate").notNull(),method:_("method",["natural","artificial","embryo_transfer"]).notNull(),veterinarianName:c("veterinarianName",{length:100}),cost:i("cost"),pregnancyConfirmed:k("pregnancyConfirmed").default(!1),confirmationDate:V("confirmationDate"),dueDate:V("dueDate"),notes:w("notes"),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),be=A("foals",{id:i("id").autoincrement().primaryKey(),breedingId:i("breedingId").notNull(),horseId:i("horseId"),birthDate:V("birthDate").notNull(),gender:_("gender",["colt","filly"]),name:c("name",{length:100}),color:c("color",{length:50}),markings:w("markings"),birthWeight:i("birthWeight"),currentWeight:i("currentWeight"),healthStatus:c("healthStatus",{length:100}),milestones:w("milestones"),notes:w("notes"),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),Ws=A("pedigree",{id:i("id").autoincrement().primaryKey(),horseId:i("horseId").notNull(),sireId:i("sireId"),sireName:c("sireName",{length:200}),damId:i("damId"),damName:c("damName",{length:200}),sireOfSireId:i("sireOfSireId"),sireOfSireName:c("sireOfSireName",{length:200}),damOfSireId:i("damOfSireId"),damOfSireName:c("damOfSireName",{length:200}),sireOfDamId:i("sireOfDamId"),sireOfDamName:c("sireOfDamName",{length:200}),damOfDamId:i("damOfDamId"),damOfDamName:c("damOfDamName",{length:200}),geneticInfo:w("geneticInfo"),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),P=A("lessonBookings",{id:i("id").autoincrement().primaryKey(),trainerId:i("trainerId").notNull(),clientId:i("clientId").notNull(),horseId:i("horseId"),lessonDate:p("lessonDate").notNull(),duration:i("duration").notNull(),lessonType:c("lessonType",{length:100}),location:c("location",{length:200}),status:_("status",["scheduled","completed","cancelled","no_show"]).default("scheduled").notNull(),fee:i("fee"),paid:k("paid").default(!1).notNull(),notes:w("notes"),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),z=A("trainerAvailability",{id:i("id").autoincrement().primaryKey(),trainerId:i("trainerId").notNull(),dayOfWeek:i("dayOfWeek").notNull(),startTime:c("startTime",{length:5}).notNull(),endTime:c("endTime",{length:5}).notNull(),isActive:k("isActive").default(!0).notNull(),createdAt:p("createdAt").defaultNow().notNull()}),v=A("apiKeys",{id:i("id").autoincrement().primaryKey(),userId:i("userId").notNull(),stableId:i("stableId"),name:c("name",{length:100}).notNull(),keyHash:c("keyHash",{length:255}).notNull(),keyPrefix:c("keyPrefix",{length:20}).notNull(),permissions:w("permissions"),rateLimit:i("rateLimit").default(100).notNull(),isActive:k("isActive").default(!0).notNull(),lastUsedAt:p("lastUsedAt"),expiresAt:p("expiresAt"),createdAt:p("createdAt").defaultNow().notNull()}),Vs=A("webhooks",{id:i("id").autoincrement().primaryKey(),userId:i("userId").notNull(),stableId:i("stableId"),url:w("url").notNull(),events:w("events").notNull(),secret:c("secret",{length:255}).notNull(),isActive:k("isActive").default(!0).notNull(),lastTriggeredAt:p("lastTriggeredAt"),failureCount:i("failureCount").default(0),createdAt:p("createdAt").defaultNow().notNull()})});import{config as ht}from"dotenv";import{existsSync as hn}from"fs";import{resolve as wn}from"path";function bn(){let t=[{name:"DATABASE_URL",description:"Database connection string"},{name:"JWT_SECRET",description:"JWT secret for token signing"},{name:"ADMIN_UNLOCK_PASSWORD",description:"Admin unlock password"}],e=[];t.forEach(s=>{process.env[s.name]||e.push(s)}),Ve&&[{name:"STRIPE_SECRET_KEY",description:"Stripe secret key"},{name:"STRIPE_WEBHOOK_SECRET",description:"Stripe webhook secret"}].forEach(o=>{process.env[o.name]||e.push(o)}),Je&&[{name:"BUILT_IN_FORGE_API_URL",description:"Forge API URL"},{name:"BUILT_IN_FORGE_API_KEY",description:"Forge API key"}].forEach(o=>{process.env[o.name]||e.push(o)}),e.length>0&&(console.error(`\u274C STARTUP ERROR: Missing required environment variables
`),console.error(`The following required environment variables are not set:
`),e.forEach(s=>{console.error(`  \u2022 ${s.name} - ${s.description}`)}),console.error(`
Feature flags:`),console.error(`  \u2022 ENABLE_STRIPE=${Ve}`),console.error(`  \u2022 ENABLE_UPLOADS=${Je}`),console.error(`
Please configure all required environment variables in your .env file.`),console.error(`See .env.example for a complete list of available options.
`),process.exit(1)),We&&(process.env.ADMIN_UNLOCK_PASSWORD==="ashmor12@"||process.env.ADMIN_UNLOCK_PASSWORD==="EquiProfile2026!Admin")&&(console.error("\u274C PRODUCTION ERROR: ADMIN_UNLOCK_PASSWORD is still set to default value!"),console.error("You MUST change this to a secure password before running in production."),console.error(`Generate a secure password and update your .env file.
`),process.exit(1)),We&&["FHnuavgCmZtlXQ2AAxgq+bmpt6D4Iqfl","your_secure_jwt_secret_here","your_super_secret_jwt_key_change_this_in_production"].includes(process.env.JWT_SECRET||"")&&(console.error("\u274C PRODUCTION ERROR: JWT_SECRET is still set to a default value!"),console.error("Generate a secure secret with: openssl rand -base64 32"),console.error(`Update your .env file before running in production.
`),process.exit(1)),process.env.OAUTH_SERVER_URL?process.env.VITE_APP_ID?console.log("\u2705 OAuth configured:",process.env.OAUTH_SERVER_URL):(console.warn("\u26A0\uFE0F  WARNING: OAUTH_SERVER_URL is set but VITE_APP_ID is missing."),console.warn(`   OAuth login will not work correctly without an app ID.
`)):console.log("\u2139\uFE0F  OAuth not configured - using email/password authentication only"),console.log("\u2139\uFE0F  Feature flags:"),console.log(`   \u2022 Stripe billing: ${Ve?"\u2705 enabled":"\u274C disabled"}`),console.log(`   \u2022 Document uploads: ${Je?"\u2705 enabled":"\u274C disabled"}`),We&&process.env.JWT_SECRET&&process.env.JWT_SECRET.length<32&&(console.error("\u274C PRODUCTION ERROR: JWT_SECRET must be at least 32 characters long!"),console.error(`Generate a secure secret with: openssl rand -base64 32
`),process.exit(1))}var We,Ve,Je,y,re=gt(()=>{"use strict";We=process.env.NODE_ENV==="production";if(We)ht();else{ht();let t=wn(process.cwd(),".env.default");hn(t)&&ht({path:t,override:!1})}Ve=process.env.ENABLE_STRIPE==="true",Je=process.env.ENABLE_UPLOADS==="true";bn();y={enableStripe:Ve,enableUploads:Je,appId:process.env.VITE_APP_ID??"",cookieSecret:process.env.JWT_SECRET??"",databaseUrl:process.env.DATABASE_URL??"",oAuthServerUrl:process.env.OAUTH_SERVER_URL??"",ownerOpenId:process.env.OWNER_OPEN_ID??"",isProduction:process.env.NODE_ENV==="production",forgeApiUrl:process.env.BUILT_IN_FORGE_API_URL??"",forgeApiKey:process.env.BUILT_IN_FORGE_API_KEY??"",adminUnlockPassword:process.env.ADMIN_UNLOCK_PASSWORD??"ashmor12@",baseUrl:process.env.BASE_URL??"http://localhost:3000",cookieDomain:process.env.COOKIE_DOMAIN??void 0,cookieSecure:process.env.COOKIE_SECURE==="true",stripeSecretKey:process.env.STRIPE_SECRET_KEY??"",stripeWebhookSecret:process.env.STRIPE_WEBHOOK_SECRET??"",awsAccessKeyId:process.env.AWS_ACCESS_KEY_ID??"",awsSecretAccessKey:process.env.AWS_SECRET_ACCESS_KEY??"",awsRegion:process.env.AWS_REGION??"eu-west-2",awsS3Bucket:process.env.AWS_S3_BUCKET??"",openaiApiKey:process.env.OPENAI_API_KEY??""}});var Ae={};yn(Ae,{createAdminSession:()=>er,createApiKey:()=>ar,createBackupLog:()=>An,createCompetition:()=>Tn,createDeworming:()=>Rn,createDocument:()=>Ht,createFeedingPlan:()=>jt,createHealthRecord:()=>Dt,createHorse:()=>vt,createStripeEvent:()=>Xt,createTrainingSession:()=>Pt,createVaccination:()=>Nn,createWeatherLog:()=>Kt,deleteDocument:()=>Mt,deleteFeedingPlan:()=>$t,deleteHealthRecord:()=>Ot,deleteHorse:()=>Tt,deleteTrainingSession:()=>Bt,deleteUser:()=>At,getActivityLogs:()=>Gt,getAdminSession:()=>ot,getAllSettings:()=>Jt,getAllUsers:()=>Se,getCompetitionsByHorseId:()=>Dn,getCompetitionsByUserId:()=>_n,getDb:()=>l,getDewormingsByHorseId:()=>xn,getDocumentsByHorseId:()=>Ft,getDocumentsByUserId:()=>rt,getExpiredTrials:()=>Nt,getFeedingPlansByHorseId:()=>Lt,getFeedingPlansByUserId:()=>tt,getHealthRecordById:()=>Ut,getHealthRecordsByHorseId:()=>_t,getHealthRecordsByUserId:()=>ze,getHorseById:()=>Rt,getHorsesByUserId:()=>Ue,getLatestWeatherLog:()=>nt,getOverdueSubscriptions:()=>Et,getRecentBackups:()=>zt,getSetting:()=>Sn,getSystemStats:()=>Qt,getTrainingSessionsByHorseId:()=>Ct,getTrainingSessionsByUserId:()=>Xe,getUnlockAttempts:()=>rr,getUnlockLockoutTime:()=>ir,getUpcomingReminders:()=>Qe,getUpcomingTrainingSessions:()=>Ze,getUserActivityLogs:()=>Yt,getUserByEmail:()=>qe,getUserById:()=>Z,getUserByOpenId:()=>_e,getVaccinationsByHorseId:()=>vn,getWeatherHistory:()=>Wt,incrementUnlockAttempts:()=>nr,isStripeEventProcessed:()=>Zt,listApiKeys:()=>lr,logActivity:()=>q,markStripeEventProcessed:()=>st,resetUnlockAttempts:()=>sr,revokeAdminSession:()=>tr,revokeApiKey:()=>dr,rotateApiKey:()=>cr,setUnlockLockout:()=>or,suspendUser:()=>It,unsuspendUser:()=>St,updateApiKeySettings:()=>ur,updateBackupLog:()=>En,updateFeedingPlan:()=>qt,updateHealthRecord:()=>kt,updateHorse:()=>xt,updateTrainingSession:()=>et,updateUser:()=>G,upsertSetting:()=>Vt,upsertUser:()=>Ie,verifyApiKey:()=>Un});import{eq as u,and as R,desc as M,sql as se,gte as wt,lte as Ur}from"drizzle-orm";import{drizzle as In}from"drizzle-orm/mysql2";import bt from"bcrypt";import{nanoid as Ye}from"nanoid";async function l(){if(!Ge&&process.env.DATABASE_URL)try{Ge=In(process.env.DATABASE_URL)}catch(t){console.warn("[Database] Failed to connect:",t),Ge=null}return Ge}async function Ie(t){if(!t.openId)throw new Error("User openId is required for upsert");let e=await l();if(!e){console.warn("[Database] Cannot upsert user: database not available");return}try{let r={openId:t.openId},s={},o=["name","email","loginMethod"],a=d=>{let h=t[d];if(h===void 0)return;let g=h??null;r[d]=g,s[d]=g};if(o.forEach(a),t.lastSignedIn!==void 0&&(r.lastSignedIn=t.lastSignedIn,s.lastSignedIn=t.lastSignedIn),t.role!==void 0?(r.role=t.role,s.role=t.role):t.openId===y.ownerOpenId&&(r.role="admin",s.role="admin"),!r.trialEndsAt){let d=new Date;d.setDate(d.getDate()+7),r.trialEndsAt=d,r.subscriptionStatus="trial"}r.lastSignedIn||(r.lastSignedIn=new Date),Object.keys(s).length===0&&(s.lastSignedIn=new Date),await e.insert(O).values(r).onDuplicateKeyUpdate({set:s})}catch(r){throw console.error("[Database] Failed to upsert user:",r),r}}async function _e(t){let e=await l();if(!e)return;let r=await e.select().from(O).where(u(O.openId,t)).limit(1);return r.length>0?r[0]:void 0}async function Z(t){let e=await l();if(!e)return;let r=await e.select().from(O).where(u(O.id,t)).limit(1);return r.length>0?r[0]:void 0}async function qe(t){let e=await l();if(!e)return;let r=await e.select().from(O).where(u(O.email,t)).limit(1);return r.length>0?r[0]:void 0}async function Se(){let t=await l();return t?t.select().from(O).orderBy(M(O.createdAt)):[]}async function G(t,e){let r=await l();r&&await r.update(O).set({...e,updatedAt:new Date}).where(u(O.id,t))}async function It(t,e){let r=await l();r&&await r.update(O).set({isSuspended:!0,suspendedReason:e,updatedAt:new Date}).where(u(O.id,t))}async function St(t){let e=await l();e&&await e.update(O).set({isSuspended:!1,suspendedReason:null,updatedAt:new Date}).where(u(O.id,t))}async function At(t){let e=await l();e&&await e.update(O).set({isActive:!1,updatedAt:new Date}).where(u(O.id,t))}async function Et(){let t=await l();if(!t)return[];let e=new Date;return t.select().from(O).where(R(u(O.subscriptionStatus,"overdue"),u(O.isActive,!0)))}async function Nt(){let t=await l();if(!t)return[];let e=new Date;return t.select().from(O).where(R(u(O.subscriptionStatus,"trial"),Ur(O.trialEndsAt,e),u(O.isActive,!0)))}async function vt(t){let e=await l();if(!e)throw new Error("Database not available");return(await e.insert(D).values(t))[0].insertId}async function Ue(t){let e=await l();return e?e.select().from(D).where(R(u(D.userId,t),u(D.isActive,!0))).orderBy(M(D.createdAt)):[]}async function Rt(t,e){let r=await l();if(!r)return;let s=await r.select().from(D).where(R(u(D.id,t),u(D.userId,e))).limit(1);return s.length>0?s[0]:void 0}async function xt(t,e,r){let s=await l();s&&await s.update(D).set({...r,updatedAt:new Date}).where(R(u(D.id,t),u(D.userId,e)))}async function Tt(t,e){let r=await l();r&&await r.update(D).set({isActive:!1,updatedAt:new Date}).where(R(u(D.id,t),u(D.userId,e)))}async function Dt(t){let e=await l();if(!e)throw new Error("Database not available");return(await e.insert(E).values(t))[0].insertId}async function ze(t){let e=await l();return e?e.select().from(E).where(u(E.userId,t)).orderBy(M(E.recordDate)):[]}async function _t(t,e){let r=await l();return r?r.select().from(E).where(R(u(E.horseId,t),u(E.userId,e))).orderBy(M(E.recordDate)):[]}async function Ut(t,e){let r=await l();if(!r)return;let s=await r.select().from(E).where(R(u(E.id,t),u(E.userId,e))).limit(1);return s.length>0?s[0]:void 0}async function kt(t,e,r){let s=await l();s&&await s.update(E).set({...r,updatedAt:new Date}).where(R(u(E.id,t),u(E.userId,e)))}async function Ot(t,e){let r=await l();r&&await r.delete(E).where(R(u(E.id,t),u(E.userId,e)))}async function Qe(t,e=30){let r=await l();if(!r)return[];let s=new Date,o=new Date;return o.setDate(o.getDate()+e),r.select().from(E).where(R(u(E.userId,t),wt(E.nextDueDate,s),Ur(E.nextDueDate,o))).orderBy(E.nextDueDate)}async function Pt(t){let e=await l();if(!e)throw new Error("Database not available");return(await e.insert(x).values(t))[0].insertId}async function Ct(t,e){let r=await l();return r?r.select().from(x).where(R(u(x.horseId,t),u(x.userId,e))).orderBy(M(x.sessionDate)):[]}async function Xe(t){let e=await l();return e?e.select().from(x).where(u(x.userId,t)).orderBy(M(x.sessionDate)):[]}async function Ze(t){let e=await l();if(!e)return[];let r=new Date;return e.select().from(x).where(R(u(x.userId,t),wt(x.sessionDate,r),u(x.isCompleted,!1))).orderBy(x.sessionDate)}async function et(t,e,r){let s=await l();s&&await s.update(x).set({...r,updatedAt:new Date}).where(R(u(x.id,t),u(x.userId,e)))}async function Bt(t,e){let r=await l();r&&await r.delete(x).where(R(u(x.id,t),u(x.userId,e)))}async function jt(t){let e=await l();if(!e)throw new Error("Database not available");return(await e.insert(K).values(t))[0].insertId}async function tt(t){let e=await l();return e?e.select().from(K).where(R(u(K.userId,t),u(K.isActive,!0))).orderBy(K.mealTime):[]}async function Lt(t,e){let r=await l();return r?r.select().from(K).where(R(u(K.horseId,t),u(K.userId,e),u(K.isActive,!0))).orderBy(K.mealTime):[]}async function qt(t,e,r){let s=await l();s&&await s.update(K).set({...r,updatedAt:new Date}).where(R(u(K.id,t),u(K.userId,e)))}async function $t(t,e){let r=await l();r&&await r.update(K).set({isActive:!1,updatedAt:new Date}).where(R(u(K.id,t),u(K.userId,e)))}async function Ht(t){let e=await l();if(!e)throw new Error("Database not available");return(await e.insert(te).values(t))[0].insertId}async function rt(t){let e=await l();return e?e.select().from(te).where(u(te.userId,t)).orderBy(M(te.createdAt)):[]}async function Ft(t,e){let r=await l();return r?r.select().from(te).where(R(u(te.horseId,t),u(te.userId,e))).orderBy(M(te.createdAt)):[]}async function Mt(t,e){let r=await l();r&&await r.delete(te).where(R(u(te.id,t),u(te.userId,e)))}async function Kt(t){let e=await l();if(!e)throw new Error("Database not available");return(await e.insert(pe).values(t))[0].insertId}async function nt(t){let e=await l();if(!e)return;let r=await e.select().from(pe).where(u(pe.userId,t)).orderBy(M(pe.checkedAt)).limit(1);return r.length>0?r[0]:void 0}async function Wt(t,e=7){let r=await l();return r?r.select().from(pe).where(u(pe.userId,t)).orderBy(M(pe.checkedAt)).limit(e):[]}async function Sn(t){let e=await l();if(!e)return;let r=await e.select().from(Ne).where(u(Ne.settingKey,t)).limit(1);return r.length>0?r[0]:void 0}async function Vt(t,e,r="string",s,o){let a=await l();a&&await a.insert(Ne).values({settingKey:t,settingValue:e,settingType:r,description:s,updatedBy:o}).onDuplicateKeyUpdate({set:{settingValue:e,updatedBy:o,updatedAt:new Date}})}async function Jt(){let t=await l();return t?t.select().from(Ne).orderBy(Ne.settingKey):[]}async function q(t){let e=await l();e&&await e.insert(we).values(t)}async function Gt(t=100){let e=await l();return e?e.select().from(we).orderBy(M(we.createdAt)).limit(t):[]}async function Yt(t,e=50){let r=await l();return r?r.select().from(we).where(u(we.userId,t)).orderBy(M(we.createdAt)).limit(e):[]}async function An(t){let e=await l();if(!e)throw new Error("Database not available");return(await e.insert(ve).values(t))[0].insertId}async function En(t,e){let r=await l();r&&await r.update(ve).set(e).where(u(ve.id,t))}async function zt(t=10){let e=await l();return e?e.select().from(ve).orderBy(M(ve.startedAt)).limit(t):[]}async function Qt(){let t=await l();if(!t)return null;let[e]=await t.select({totalUsers:se`COUNT(*)`,activeUsers:se`SUM(CASE WHEN isActive = 1 THEN 1 ELSE 0 END)`,trialUsers:se`SUM(CASE WHEN subscriptionStatus = 'trial' THEN 1 ELSE 0 END)`,paidUsers:se`SUM(CASE WHEN subscriptionStatus = 'active' THEN 1 ELSE 0 END)`,overdueUsers:se`SUM(CASE WHEN subscriptionStatus = 'overdue' THEN 1 ELSE 0 END)`,suspendedUsers:se`SUM(CASE WHEN isSuspended = 1 THEN 1 ELSE 0 END)`}).from(O),[r]=await t.select({totalHorses:se`COUNT(*)`,activeHorses:se`SUM(CASE WHEN isActive = 1 THEN 1 ELSE 0 END)`}).from(D),[s]=await t.select({totalRecords:se`COUNT(*)`}).from(E),[o]=await t.select({totalSessions:se`COUNT(*)`,completedSessions:se`SUM(CASE WHEN isCompleted = 1 THEN 1 ELSE 0 END)`}).from(x);return{users:e,horses:r,healthRecords:s,trainingSessions:o}}async function Xt(t,e,r){let s=await l();if(!s)return null;try{return(await s.insert(Te).values({eventId:t,eventType:e,payload:r}))[0].insertId}catch{return null}}async function st(t,e){let r=await l();r&&await r.update(Te).set({processed:!0,processedAt:new Date,error:e}).where(u(Te.eventId,t))}async function Zt(t){let e=await l();return e?(await e.select().from(Te).where(u(Te.eventId,t)).limit(1)).length>0:!1}async function Nn(t){let e=await l();if(!e)throw new Error("Database not available");return(await e.insert(Re).values(t))[0].insertId}async function vn(t,e){let r=await l();return r?r.select().from(Re).where(R(u(Re.horseId,t),u(Re.userId,e))).orderBy(M(Re.dateAdministered)):[]}async function Rn(t){let e=await l();if(!e)throw new Error("Database not available");return(await e.insert(xe).values(t))[0].insertId}async function xn(t,e){let r=await l();return r?r.select().from(xe).where(R(u(xe.horseId,t),u(xe.userId,e))).orderBy(M(xe.dateAdministered)):[]}async function Tn(t){let e=await l();if(!e)throw new Error("Database not available");return(await e.insert(Y).values(t))[0].insertId}async function Dn(t,e){let r=await l();return r?r.select().from(Y).where(R(u(Y.horseId,t),u(Y.userId,e))).orderBy(M(Y.date)):[]}async function _n(t){let e=await l();return e?e.select().from(Y).where(u(Y.userId,t)).orderBy(M(Y.date)):[]}async function ot(t){let e=await l();return e&&(await e.select().from(ae).where(R(u(ae.userId,t),wt(ae.expiresAt,new Date))).limit(1))[0]||null}async function er(t,e){let r=await l();if(!r)throw new Error("Database not available");await r.delete(ae).where(u(ae.userId,t)),await r.insert(ae).values({userId:t,expiresAt:e})}async function tr(t){let e=await l();e&&await e.delete(ae).where(u(ae.userId,t))}async function rr(t){let e=await l();if(!e)return 0;let r=await e.select().from(J).where(u(J.userId,t)).limit(1);return r[0]?r[0].lockedUntil&&r[0].lockedUntil<new Date?(await e.update(J).set({attempts:0,lockedUntil:null}).where(u(J.userId,t)),0):r[0].attempts:0}async function nr(t){let e=await l();if(!e)return 0;let r=await e.select().from(J).where(u(J.userId,t)).limit(1);if(!r[0])return await e.insert(J).values({userId:t,attempts:1,lastAttemptAt:new Date}),1;let s=r[0].attempts+1;return await e.update(J).set({attempts:s,lastAttemptAt:new Date}).where(u(J.userId,t)),s}async function sr(t){let e=await l();e&&await e.update(J).set({attempts:0,lockedUntil:null}).where(u(J.userId,t))}async function or(t,e){let r=await l();if(!r)return;let s=new Date(Date.now()+e*60*1e3);await r.update(J).set({lockedUntil:s}).where(u(J.userId,t))}async function ir(t){let e=await l();return e&&(await e.select().from(J).where(u(J.userId,t)).limit(1))[0]?.lockedUntil||null}async function ar(t){let e=await l();if(!e)throw new Error("Database not available");let r="ep_"+Ye(4),s=Ye(32),o=r+"_"+s,a=await bt.hash(o,10);return{id:(await e.insert(v).values({userId:t.userId,stableId:t.stableId,name:t.name,keyHash:a,keyPrefix:r,permissions:t.permissions?JSON.stringify(t.permissions):null,rateLimit:t.rateLimit??100,expiresAt:t.expiresAt}))[0].insertId,key:o}}async function lr(t){let e=await l();return e?e.select({id:v.id,name:v.name,keyPrefix:v.keyPrefix,isActive:v.isActive,rateLimit:v.rateLimit,lastUsedAt:v.lastUsedAt,expiresAt:v.expiresAt,createdAt:v.createdAt}).from(v).where(u(v.userId,t)).orderBy(M(v.createdAt)):[]}async function dr(t,e){let r=await l();r&&await r.update(v).set({isActive:!1}).where(R(u(v.id,t),u(v.userId,e)))}async function cr(t,e){let r=await l();if(!r||!(await r.select().from(v).where(R(u(v.id,t),u(v.userId,e))).limit(1))[0])return null;let o="ep_"+Ye(4),a=Ye(32),d=o+"_"+a,h=await bt.hash(d,10);return await r.update(v).set({keyHash:h,keyPrefix:o}).where(R(u(v.id,t),u(v.userId,e))),{key:d}}async function ur(t,e,r){let s=await l();if(!s)return;let o={};r.name!==void 0&&(o.name=r.name),r.rateLimit!==void 0&&(o.rateLimit=r.rateLimit),r.permissions!==void 0&&(o.permissions=JSON.stringify(r.permissions)),r.isActive!==void 0&&(o.isActive=r.isActive),await s.update(v).set(o).where(R(u(v.id,t),u(v.userId,e)))}async function Un(t){let e=await l();if(!e)return null;let r=t.substring(0,7),s=await e.select().from(v).where(R(u(v.keyPrefix,r),u(v.isActive,!0)));for(let o of s)if(await bt.compare(t,o.keyHash)){if(o.expiresAt&&o.expiresAt<new Date)return null;await e.update(v).set({lastUsedAt:new Date}).where(u(v.id,o.id));let d=o.permissions?JSON.parse(o.permissions):[];return{userId:o.userId,permissions:d}}return null}var Ge,le=gt(()=>{"use strict";Ke();re();Ge=null});import"dotenv/config";import ft from"express";import{createServer as Ts}from"http";import Ds from"net";import _s from"helmet";import mn from"express-rate-limit";import{createExpressMiddleware as Us}from"@trpc/server/adapters/express";var oe="app_session_id";var Rr="Please login (10001)",xr="You do not have required permission (10002)";le();function kn(t){if(t.protocol==="https")return!0;let e=t.headers["x-forwarded-proto"];return e?(Array.isArray(e)?e:e.split(",")).some(s=>s.trim().toLowerCase()==="https"):!1}function it(t){return{httpOnly:!0,path:"/",sameSite:"none",secure:kn(t)}}var pr=class extends Error{constructor(r,s){super(s);this.statusCode=r;this.name="HttpError"}};var $e=t=>new pr(403,t);le();re();import Pn from"axios";import{parse as Cn}from"cookie";import{SignJWT as Bn,jwtVerify as jn}from"jose";var mr=t=>typeof t=="string"&&t.length>0,Ln="/webdev.v1.WebDevAuthPublicService/ExchangeToken",qn="/webdev.v1.WebDevAuthPublicService/GetUserInfo",$n="/webdev.v1.WebDevAuthPublicService/GetUserInfoWithJwt",fr=class{constructor(e){this.client=e;console.log("[OAuth] Initialized with baseURL:",y.oAuthServerUrl),y.oAuthServerUrl||console.error("[OAuth] ERROR: OAUTH_SERVER_URL is not configured! Set OAUTH_SERVER_URL environment variable.")}decodeState(e){return atob(e)}async getTokenByCode(e,r){let s={clientId:y.appId,grantType:"authorization_code",code:e,redirectUri:this.decodeState(r)},{data:o}=await this.client.post(Ln,s);return o}async getUserInfoByToken(e){let{data:r}=await this.client.post(qn,{accessToken:e.accessToken});return r}},Hn=()=>Pn.create({baseURL:y.oAuthServerUrl,timeout:3e4}),gr=class{client;oauthService;constructor(e=Hn()){this.client=e,this.oauthService=new fr(this.client)}deriveLoginMethod(e,r){if(r&&r.length>0)return r;if(!Array.isArray(e)||e.length===0)return null;let s=new Set(e.filter(a=>typeof a=="string"));if(s.has("REGISTERED_PLATFORM_EMAIL"))return"email";if(s.has("REGISTERED_PLATFORM_GOOGLE"))return"google";if(s.has("REGISTERED_PLATFORM_APPLE"))return"apple";if(s.has("REGISTERED_PLATFORM_MICROSOFT")||s.has("REGISTERED_PLATFORM_AZURE"))return"microsoft";if(s.has("REGISTERED_PLATFORM_GITHUB"))return"github";let o=Array.from(s)[0];return o?o.toLowerCase():null}async exchangeCodeForToken(e,r){return this.oauthService.getTokenByCode(e,r)}async getUserInfo(e){let r=await this.oauthService.getUserInfoByToken({accessToken:e}),s=this.deriveLoginMethod(r?.platforms,r?.platform??r.platform??null);return{...r,platform:s,loginMethod:s}}parseCookies(e){if(!e)return new Map;let r=Cn(e);return new Map(Object.entries(r))}getSessionSecret(){let e=y.cookieSecret;return new TextEncoder().encode(e)}async createSessionToken(e,r={}){return this.signSession({openId:e,appId:y.appId,name:r.name||""},r)}async signSession(e,r={}){let s=Date.now(),o=r.expiresInMs??31536e6,a=Math.floor((s+o)/1e3),d=this.getSessionSecret();return new Bn({openId:e.openId,appId:e.appId,name:e.name}).setProtectedHeader({alg:"HS256",typ:"JWT"}).setExpirationTime(a).sign(d)}async verifySession(e){if(!e)return console.warn("[Auth] Missing session cookie"),null;try{let r=this.getSessionSecret(),{payload:s}=await jn(e,r,{algorithms:["HS256"]}),{openId:o,appId:a,name:d,userId:h}=s;return typeof h=="number"?{openId:"",appId:y.appId,name:"",userId:h}:!mr(o)||!mr(a)||!mr(d)?(console.warn("[Auth] Session payload missing required fields"),null):{openId:o,appId:a,name:d}}catch(r){return console.warn("[Auth] Session verification failed",String(r)),null}}async getUserInfoWithJwt(e){let r={jwtToken:e,projectId:y.appId},{data:s}=await this.client.post($n,r),o=this.deriveLoginMethod(s?.platforms,s?.platform??s.platform??null);return{...s,platform:o,loginMethod:o}}async authenticateRequest(e){let s=this.parseCookies(e.headers.cookie).get(oe),o=await this.verifySession(s);if(!o)throw $e("Invalid session cookie");let a=new Date,d;if(o.userId){if(d=await Z(o.userId),!d)throw $e("User not found")}else{let h=o.openId;if(d=await _e(h),!d)try{let g=await this.getUserInfoWithJwt(s??"");await Ie({openId:g.openId,name:g.name||null,email:g.email??null,loginMethod:g.loginMethod??g.platform??null,lastSignedIn:a}),d=await _e(g.openId)}catch(g){throw console.error("[Auth] Failed to sync user from OAuth:",g),$e("Failed to sync user info")}}if(!d)throw $e("User not found");return await G(d.id,{lastSignedIn:a}),d}},de=new gr;function kr(t,e){let r=t.query[e];return typeof r=="string"?r:void 0}function Or(t){t.get("/api/oauth/callback",async(e,r)=>{let s=kr(e,"code"),o=kr(e,"state");if(!s){console.error("[OAuth] Missing authorization code"),r.status(400).send(`
        <html>
          <body>
            <h1>OAuth Error</h1>
            <p>Missing authorization code. The OAuth callback requires a 'code' parameter.</p>
            <p><a href="/">Return to home</a></p>
          </body>
        </html>
      `);return}if(!o){console.error("[OAuth] Missing state parameter"),r.status(400).send(`
        <html>
          <body>
            <h1>OAuth Error</h1>
            <p>Missing state parameter. The OAuth callback requires a 'state' parameter for security.</p>
            <p><a href="/">Return to home</a></p>
          </body>
        </html>
      `);return}try{let a=await de.exchangeCodeForToken(s,o),d=await de.getUserInfo(a.accessToken);if(!d.openId){console.error("[OAuth] Missing openId in user info"),r.status(400).send(`
          <html>
            <body>
              <h1>OAuth Error</h1>
              <p>Unable to retrieve user identification from OAuth provider.</p>
              <p><a href="/">Return to home</a></p>
            </body>
          </html>
        `);return}await Ie({openId:d.openId,name:d.name||null,email:d.email??null,loginMethod:d.loginMethod??d.platform??null,lastSignedIn:new Date});let h=await de.createSessionToken(d.openId,{name:d.name||"",expiresInMs:31536e6}),g=it(e);r.cookie(oe,h,{...g,maxAge:31536e6}),r.redirect(302,"/")}catch(a){console.error("[OAuth] Callback failed",a);let d=g=>g.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),h=a instanceof Error?d(a.message):"Unknown error";r.status(500).send(`
        <html>
          <body>
            <h1>OAuth Authentication Failed</h1>
            <p>Failed to complete OAuth authentication: ${h}</p>
            <p>Please try logging in again or contact support if the problem persists.</p>
            <p><a href="/">Return to home</a></p>
          </body>
        </html>
      `)}})}le();import Vn from"express";import wr from"bcrypt";import{nanoid as qr}from"nanoid";import{SignJWT as $r}from"jose";import Fn from"nodemailer";var yr={host:process.env.SMTP_HOST||"smtp.gmail.com",port:parseInt(process.env.SMTP_PORT||"587"),secure:!1,auth:{user:process.env.SMTP_USER||"",pass:process.env.SMTP_PASS||""}},Mn=process.env.SMTP_FROM||'"EquiProfile" <noreply@equiprofile.online>',hr=null;function Kn(){if(!yr.auth.user||!yr.auth.pass)return console.warn("[Email] SMTP not configured (SMTP_USER and SMTP_PASS required)"),null;if(!hr)try{hr=Fn.createTransport(yr),console.log("[Email] SMTP transporter initialized")}catch(t){return console.error("[Email] Failed to initialize transporter:",t),null}return hr}async function lt(t,e,r,s){let o=Kn();if(!o){console.warn("[Email] Skipping email send - SMTP not configured");return}try{await o.sendMail({from:Mn,to:t,subject:e,html:r,text:s||Wn(r)}),console.log(`[Email] Sent "${e}" to ${t}`)}catch(a){console.error(`[Email] Failed to send "${e}" to ${t}:`,a)}}async function Pr(t){if(!t.email){console.warn("[Email] Cannot send welcome email - user has no email");return}let e=t.trialEndsAt?Math.ceil((t.trialEndsAt.getTime()-Date.now())/(1e3*60*60*24)):7,r="Welcome to EquiProfile!",s=`
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
      <h1 style="color: #1e40af;">Welcome to EquiProfile, ${t.name||"there"}! \u{1F434}</h1>
      
      <p>Thank you for joining EquiProfile, the comprehensive horse management platform!</p>
      
      <div style="background: #f3f4f6; padding: 20px; border-radius: 8px; margin: 20px 0;">
        <h2 style="margin-top: 0; color: #1e40af;">Your ${e}-Day Free Trial</h2>
        <p>You have <strong>${e} days</strong> to explore all premium features:</p>
        <ul>
          <li>\u{1F4CB} Health records and vaccination tracking</li>
          <li>\u{1F3CB}\uFE0F Training session management</li>
          <li>\u{1F37D}\uFE0F Feeding schedules and nutrition plans</li>
          <li>\u{1F4C5} Calendar and event reminders</li>
          <li>\u2601\uFE0F AI-powered weather analysis</li>
          <li>\u{1F4C4} Secure document storage</li>
        </ul>
      </div>
      
      <h3>Getting Started:</h3>
      <ol>
        <li>Add your first horse profile</li>
        <li>Log health records and vaccinations</li>
        <li>Set up feeding schedules</li>
        <li>Explore the dashboard analytics</li>
      </ol>
      
      <p style="margin-top: 30px;">
        <a href="${process.env.BASE_URL||"https://equiprofile.online"}/dashboard" 
           style="background: #1e40af; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">
          Go to Dashboard
        </a>
      </p>
      
      <p style="color: #6b7280; margin-top: 30px;">
        Questions? Reply to this email or contact our support team.
      </p>
      
      <p style="color: #6b7280;">
        Best regards,<br/>
        The EquiProfile Team
      </p>
    </div>
  `;await lt(t.email,r,s)}async function Cr(t,e){if(!t.email)return;let r=e==="yearly"?"Yearly":"Monthly",s=e==="yearly"?"\xA379.90/year":"\xA37.99/month",o="Payment successful - Welcome to EquiProfile Premium! \u{1F389}",a=`
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
      <h1 style="color: #10b981;">Payment Successful! \u{1F389}</h1>
      
      <p>Hi ${t.name||"there"},</p>
      
      <p>Thank you for subscribing to EquiProfile Premium! Your payment has been processed successfully.</p>
      
      <div style="background: #f0fdf4; border: 2px solid #10b981; border-radius: 8px; padding: 20px; margin: 20px 0;">
        <h2 style="margin-top: 0; color: #10b981;">Subscription Details</h2>
        <p><strong>Plan:</strong> ${r}</p>
        <p><strong>Amount:</strong> ${s}</p>
        <p><strong>Status:</strong> Active \u2705</p>
        ${t.subscriptionEndsAt?`<p><strong>Next billing date:</strong> ${t.subscriptionEndsAt.toLocaleDateString()}</p>`:""}
      </div>
      
      <p>You now have unlimited access to all premium features:</p>
      <ul>
        <li>\u2705 Unlimited horse profiles</li>
        <li>\u2705 Complete health record tracking</li>
        <li>\u2705 Training session management</li>
        <li>\u2705 Document storage (up to 5GB)</li>
        <li>\u2705 Advanced analytics and reports</li>
        <li>\u2705 Calendar and reminders</li>
        <li>\u2705 Priority support</li>
      </ul>
      
      <p style="margin-top: 30px;">
        <a href="${process.env.BASE_URL||"https://equiprofile.online"}/dashboard" 
           style="background: #1e40af; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">
          Go to Dashboard
        </a>
      </p>
      
      <p style="color: #6b7280; margin-top: 30px; font-size: 14px;">
        You can manage your subscription, update payment methods, or view invoices anytime from your 
        <a href="${process.env.BASE_URL||"https://equiprofile.online"}/billing">billing page</a>.
      </p>
      
      <p style="color: #6b7280;">
        Thank you for choosing EquiProfile!<br/>
        The EquiProfile Team
      </p>
    </div>
  `;await lt(t.email,o,a)}async function Br(t,e,r){let s=`${process.env.BASE_URL||"https://equiprofile.online"}/reset-password?token=${e}`,o="Reset your EquiProfile password",a=`
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
      <h1 style="color: #1e40af;">Password Reset Request</h1>
      
      <p>Hi ${r||"there"},</p>
      
      <p>We received a request to reset your EquiProfile password. Click the button below to create a new password:</p>
      
      <p style="text-align: center; margin: 30px 0;">
        <a href="${s}" 
           style="background: #1e40af; color: white; padding: 14px 32px; text-decoration: none; border-radius: 6px; display: inline-block; font-weight: bold;">
          Reset Password
        </a>
      </p>
      
      <p style="color: #dc2626; background: #fef2f2; padding: 15px; border-radius: 6px;">
        \u26A0\uFE0F This link will expire in <strong>1 hour</strong> for security reasons.
      </p>
      
      <p>If you didn't request a password reset, you can safely ignore this email. Your password will remain unchanged.</p>
      
      <p style="color: #6b7280; font-size: 14px; margin-top: 30px;">
        If the button doesn't work, copy and paste this link into your browser:<br/>
        <a href="${s}" style="color: #1e40af; word-break: break-all;">${s}</a>
      </p>
      
      <p style="color: #6b7280; margin-top: 30px;">
        Best regards,<br/>
        The EquiProfile Team
      </p>
    </div>
  `;await lt(t,o,a)}async function jr(t){try{return await lt(t,"EquiProfile Test Email",`
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
          <h1 style="color: #1e40af;">Test Email</h1>
          <p>This is a test email from EquiProfile SMTP configuration.</p>
          <p>If you received this, your email settings are working correctly! \u2705</p>
          <p style="color: #6b7280; margin-top: 30px;">
            Sent at: ${new Date().toISOString()}
          </p>
        </div>
      `),!0}catch(e){return console.error("[Email] Test email failed:",e),!1}}function Wn(t){return t.replace(/<style[^>]*>.*<\/style>/gm,"").replace(/<script[^>]*>.*<\/script>/gm,"").replace(/<[^>]+>/gm,"").replace(/\s\s+/g," ").trim()}re();var ke=Vn.Router();ke.post("/signup",async(t,e)=>{try{let{email:r,password:s,name:o}=t.body;if(!r||!s)return e.status(400).json({error:"Email and password are required"});if(s.length<8)return e.status(400).json({error:"Password must be at least 8 characters"});if(await qe(r))return e.status(400).json({error:"Email already registered"});let d=await wr.hash(s,10),h=`local_${qr(16)}`,g=new Date;g.setDate(g.getDate()+7),await Ie({openId:h,email:r,passwordHash:d,name:o||null,loginMethod:"email",emailVerified:!1,subscriptionStatus:"trial",trialEndsAt:g,lastSignedIn:new Date});let I=await _e(h);if(!I)return e.status(500).json({error:"Failed to create user"});let N=await new $r({userId:I.id}).setProtectedHeader({alg:"HS256"}).setExpirationTime("30d").sign(new TextEncoder().encode(y.cookieSecret));e.cookie(oe,N,{httpOnly:!0,secure:y.cookieSecure,sameSite:"lax",maxAge:720*60*60*1e3,domain:y.cookieDomain}),Pr(I).catch(H=>console.error("[Auth] Failed to send welcome email:",H)),e.json({success:!0,user:{id:I.id,name:I.name,email:I.email,role:I.role}})}catch(r){console.error("[Auth] Signup error:",r),e.status(500).json({error:"Internal server error"})}});ke.post("/login",async(t,e)=>{try{let{email:r,password:s}=t.body;if(!r||!s)return e.status(400).json({error:"Email and password are required"});let o=await qe(r);if(!o||!o.passwordHash)return e.status(401).json({error:"Invalid email or password"});if(!await wr.compare(s,o.passwordHash))return e.status(401).json({error:"Invalid email or password"});if(o.isSuspended)return e.status(403).json({error:"Account suspended",reason:o.suspendedReason});await G(o.id,{lastSignedIn:new Date});let d=await new $r({userId:o.id}).setProtectedHeader({alg:"HS256"}).setExpirationTime("30d").sign(new TextEncoder().encode(y.cookieSecret));e.cookie(oe,d,{httpOnly:!0,secure:y.cookieSecure,sameSite:"lax",maxAge:720*60*60*1e3,domain:y.cookieDomain}),e.json({success:!0,user:{id:o.id,name:o.name,email:o.email,role:o.role}})}catch(r){console.error("[Auth] Login error:",r),e.status(500).json({error:"Internal server error"})}});ke.post("/request-reset",async(t,e)=>{try{let{email:r}=t.body;if(!r)return e.status(400).json({error:"Email is required"});let s=await qe(r);if(!s)return console.log("[Auth] Password reset requested for non-existent email:",r),e.json({success:!0,message:"If that email exists, a reset link has been sent"});let o=qr(32),a=new Date;a.setHours(a.getHours()+1),await G(s.id,{resetToken:o,resetTokenExpiry:a}),await Br(r,o,s.name||void 0),e.json({success:!0,message:"If that email exists, a reset link has been sent"})}catch(r){console.error("[Auth] Request reset error:",r),e.status(500).json({error:"Internal server error"})}});ke.post("/reset-password",async(t,e)=>{try{let{token:r,password:s}=t.body;if(!r||!s)return e.status(400).json({error:"Token and password are required"});if(s.length<8)return e.status(400).json({error:"Password must be at least 8 characters"});let a=(await Se()).find(h=>h.resetToken===r);if(!a)return e.status(400).json({error:"Invalid or expired reset token"});if(!a.resetTokenExpiry||a.resetTokenExpiry<new Date)return e.status(400).json({error:"Reset token has expired"});let d=await wr.hash(s,10);await G(a.id,{passwordHash:d,resetToken:null,resetTokenExpiry:null}),e.json({success:!0,message:"Password reset successful. You can now login with your new password."})}catch(r){console.error("[Auth] Reset password error:",r),e.status(500).json({error:"Internal server error"})}});ke.post("/logout",(t,e)=>{e.clearCookie(oe,{httpOnly:!0,secure:y.cookieSecure,sameSite:"lax",domain:y.cookieDomain}),e.json({success:!0})});var Hr=ke;import Yn from"express";re();import Jn from"stripe";import{TRPCError as Gn}from"@trpc/server";function Fr(){if(!y.enableStripe)throw new Gn({code:"PRECONDITION_FAILED",message:"Billing is disabled"})}function He(){return y.enableStripe?process.env.STRIPE_SECRET_KEY?new Jn(process.env.STRIPE_SECRET_KEY,{apiVersion:"2025-12-15.clover",typescript:!0}):(console.warn("[Stripe] Secret key not configured"),null):(console.warn("[Stripe] Billing feature is disabled"),null)}var ne={monthly:{priceId:process.env.STRIPE_MONTHLY_PRICE_ID||"",amount:799,currency:"gbp",interval:"month"},yearly:{priceId:process.env.STRIPE_YEARLY_PRICE_ID||"",amount:7990,currency:"gbp",interval:"year"}};async function dt(t,e,r,s,o,a){Fr();let d=He();if(!d)return null;try{let h={mode:"subscription",payment_method_types:["card"],line_items:[{price:r,quantity:1}],success_url:s,cancel_url:o,metadata:{userId:t.toString()},customer_email:a?void 0:e,allow_promotion_codes:!0};a&&(h.customer=a);let g=await d.checkout.sessions.create(h);return{sessionId:g.id,url:g.url}}catch(h){return console.error("[Stripe] Failed to create checkout session:",h),null}}async function ct(t,e){Fr();let r=He();if(!r)return null;try{return(await r.billingPortal.sessions.create({customer:t,return_url:e})).url}catch(s){return console.error("[Stripe] Failed to create portal session:",s),null}}re();var br=Yn.Router();br.get("/checkout",async(t,e)=>{try{let r=await de.authenticateRequest(t);if(!r)return e.status(401).json({error:"Unauthorized"});let s=t.query.plan;if(!s||s!=="monthly"&&s!=="yearly")return e.status(400).json({error:"Invalid plan. Must be 'monthly' or 'yearly'"});let o=s==="monthly"?ne.monthly.priceId:ne.yearly.priceId;if(!o)return e.status(500).json({error:"Stripe price ID not configured"});let a=await dt(r.id,r.email||"",o,`${y.baseUrl}/billing?success=true`,`${y.baseUrl}/billing?canceled=true`,r.stripeCustomerId||void 0);if(!a)return e.status(500).json({error:"Failed to create checkout session"});e.redirect(303,a.url)}catch(r){console.error("[Billing] Checkout error:",r),e.status(500).json({error:"Internal server error"})}});br.get("/portal",async(t,e)=>{try{let r=await de.authenticateRequest(t);if(!r)return e.status(401).json({error:"Unauthorized"});if(!r.stripeCustomerId)return e.status(400).json({error:"No Stripe customer ID found"});let s=await ct(r.stripeCustomerId,`${y.baseUrl}/billing`);if(!s)return e.status(500).json({error:"Failed to create portal session"});e.redirect(303,s)}catch(r){console.error("[Billing] Portal error:",r),e.status(500).json({error:"Internal server error"})}});var Mr=br;import{z as Me}from"zod";re();import{TRPCError as Oe}from"@trpc/server";var Kr=1200,Wr=2e4,Vr=t=>t.trim(),Jr=t=>typeof t=="string"&&t.trim().length>0,zn=t=>{let e=t.endsWith("/")?t:`${t}/`;return new URL("webdevtoken.v1.WebDevService/SendNotification",e).toString()},Qn=t=>{if(!Jr(t.title))throw new Oe({code:"BAD_REQUEST",message:"Notification title is required."});if(!Jr(t.content))throw new Oe({code:"BAD_REQUEST",message:"Notification content is required."});let e=Vr(t.title),r=Vr(t.content);if(e.length>Kr)throw new Oe({code:"BAD_REQUEST",message:`Notification title must be at most ${Kr} characters.`});if(r.length>Wr)throw new Oe({code:"BAD_REQUEST",message:`Notification content must be at most ${Wr} characters.`});return{title:e,content:r}};async function Gr(t){let{title:e,content:r}=Qn(t);if(!y.forgeApiUrl)throw new Oe({code:"INTERNAL_SERVER_ERROR",message:"Notification service URL is not configured."});if(!y.forgeApiKey)throw new Oe({code:"INTERNAL_SERVER_ERROR",message:"Notification service API key is not configured."});let s=zn(y.forgeApiUrl);try{let o=await fetch(s,{method:"POST",headers:{accept:"application/json",authorization:`Bearer ${y.forgeApiKey}`,"content-type":"application/json","connect-protocol-version":"1"},body:JSON.stringify({title:e,content:r})});if(!o.ok){let a=await o.text().catch(()=>"");return console.warn(`[Notification] Failed to notify owner (${o.status} ${o.statusText})${a?`: ${a}`:""}`),!1}return!0}catch(o){return console.warn("[Notification] Error calling notification service:",o),!1}}import{initTRPC as Xn,TRPCError as Ir}from"@trpc/server";import Zn from"superjson";var Fe=Xn.context().create({transformer:Zn}),U=Fe.router,Ee=Fe.procedure,es=Fe.middleware(async t=>{let{ctx:e,next:r}=t;if(!e.user)throw new Ir({code:"UNAUTHORIZED",message:Rr});return r({ctx:{...e,user:e.user}})}),S=Fe.procedure.use(es),B=S.use(Fe.middleware(async t=>{let{ctx:e,next:r}=t;if(!e.user||e.user.role!=="admin")throw new Ir({code:"FORBIDDEN",message:xr});let o=await(await Promise.resolve().then(()=>(le(),Ae))).getAdminSession(e.user.id);if(!o||o.expiresAt<new Date)throw new Ir({code:"FORBIDDEN",message:"Admin session expired. Please unlock admin mode in AI Chat."});return r({ctx:{...e,user:e.user}})}));re();var Yr=U({health:Ee.input(Me.object({timestamp:Me.number().min(0,"timestamp cannot be negative")})).query(()=>({ok:!0})),getFeatureFlags:Ee.query(()=>({enableStripe:y.enableStripe,enableUploads:y.enableUploads})),notifyOwner:B.input(Me.object({title:Me.string().min(1,"title is required"),content:Me.string().min(1,"content is required")})).mutation(async({input:t})=>({success:await Gr(t)}))});le();import{TRPCError as m}from"@trpc/server";import{z as n}from"zod";re();var zr=t=>Array.isArray(t)?t:[t],ts=t=>{if(typeof t=="string")return{type:"text",text:t};if(t.type==="text"||t.type==="image_url"||t.type==="file_url")return t;throw new Error("Unsupported message content part")},rs=t=>{let{role:e,name:r,tool_call_id:s}=t;if(e==="tool"||e==="function"){let a=zr(t.content).map(d=>typeof d=="string"?d:JSON.stringify(d)).join(`
`);return{role:e,name:r,tool_call_id:s,content:a}}let o=zr(t.content).map(ts);return o.length===1&&o[0].type==="text"?{role:e,name:r,content:o[0].text}:{role:e,name:r,content:o}},ns=(t,e)=>{if(t){if(t==="none"||t==="auto")return t;if(t==="required"){if(!e||e.length===0)throw new Error("tool_choice 'required' was provided but no tools were configured");if(e.length>1)throw new Error("tool_choice 'required' needs a single tool or specify the tool name explicitly");return{type:"function",function:{name:e[0].function.name}}}return"name"in t?{type:"function",function:{name:t.name}}:t}},ss=()=>y.forgeApiUrl&&y.forgeApiUrl.trim().length>0?`${y.forgeApiUrl.replace(/\/$/,"")}/v1/chat/completions`:"https://forge.manus.im/v1/chat/completions",os=()=>{if(!y.forgeApiKey)throw new Error("OPENAI_API_KEY is not configured")},is=({responseFormat:t,response_format:e,outputSchema:r,output_schema:s})=>{let o=t||e;if(o){if(o.type==="json_schema"&&!o.json_schema?.schema)throw new Error("responseFormat json_schema requires a defined schema object");return o}let a=r||s;if(a){if(!a.name||!a.schema)throw new Error("outputSchema requires both name and schema");return{type:"json_schema",json_schema:{name:a.name,schema:a.schema,...typeof a.strict=="boolean"?{strict:a.strict}:{}}}}};async function Sr(t){os();let{messages:e,tools:r,toolChoice:s,tool_choice:o,outputSchema:a,output_schema:d,responseFormat:h,response_format:g}=t,I={model:"gemini-2.5-flash",messages:e.map(rs)};r&&r.length>0&&(I.tools=r);let N=ns(s||o,r);N&&(I.tool_choice=N),I.max_tokens=32768,I.thinking={budget_tokens:128};let H=is({responseFormat:h,response_format:g,outputSchema:a,output_schema:d});H&&(I.response_format=H);let ee=await fetch(ss(),{method:"POST",headers:{"content-type":"application/json",authorization:`Bearer ${y.forgeApiKey}`},body:JSON.stringify(I)});if(!ee.ok){let L=await ee.text();throw new Error(`LLM invoke failed: ${ee.status} ${ee.statusText} \u2013 ${L}`)}return await ee.json()}re();function as(){if(!y.enableUploads)throw new Error("Uploads are disabled. Set ENABLE_UPLOADS=true to enable storage features.");let t=y.forgeApiUrl,e=y.forgeApiKey;if(!t||!e)throw new Error("Storage proxy credentials missing: set BUILT_IN_FORGE_API_URL and BUILT_IN_FORGE_API_KEY");return{baseUrl:t.replace(/\/+$/,""),apiKey:e}}function ls(t,e){let r=new URL("v1/storage/upload",ds(t));return r.searchParams.set("path",Qr(e)),r}function ds(t){return t.endsWith("/")?t:`${t}/`}function Qr(t){return t.replace(/^\/+/,"")}function cs(t,e,r){let s=typeof t=="string"?new Blob([t],{type:e}):new Blob([t],{type:e}),o=new FormData;return o.append("file",s,r||"file"),o}function us(t){return{Authorization:`Bearer ${t}`}}async function Xr(t,e,r="application/octet-stream"){let{baseUrl:s,apiKey:o}=as(),a=Qr(t),d=ls(s,a),h=cs(e,r,a.split("/").pop()??a),g=await fetch(d,{method:"POST",headers:us(o),body:h});if(!g.ok){let N=await g.text().catch(()=>g.statusText);throw new Error(`Storage upload failed (${g.status} ${g.statusText}): ${N}`)}let I=(await g.json()).url;return{key:a,url:I}}import{nanoid as on}from"nanoid";function ut(t){if(t==null)return"";let e=String(t);return e.includes(",")||e.includes('"')||e.includes(`
`)?`"${e.replace(/"/g,'""')}"`:e}function Pe(t){if(!t)return"";let e=typeof t=="string"?new Date(t):t;return isNaN(e.getTime())?"":e.toISOString().split("T")[0]}function fe(t){if(!t)return"";let e=typeof t=="string"?new Date(t):t;return isNaN(e.getTime())?"":e.toISOString().replace("T"," ").split(".")[0]}function Ce(t,e){if(t.length===0)return e.join(",")+`
`;let r=[e.map(ut).join(",")];for(let s of t){let o=e.map(a=>{let d=s[a];return d instanceof Date?ut(fe(d)):ut(typeof d=="object"&&d!==null?JSON.stringify(d):d)});r.push(o.join(","))}return r.join(`
`)}function ge(t){let e=new Date().toISOString().split("T")[0];return`${t}_${e}.csv`}function Zr(t){let e=["id","name","breed","age","dateOfBirth","height","weight","color","gender","discipline","level","registrationNumber","microchipNumber","notes","createdAt"],r=t.map(s=>({...s,dateOfBirth:Pe(s.dateOfBirth),createdAt:fe(s.createdAt)}));return Ce(r,e)}function en(t){let e=["id","horseId","horseName","type","date","dueDate","veterinarian","diagnosis","treatment","medication","cost","notes","createdAt"],r=t.map(s=>({...s,date:Pe(s.date),dueDate:Pe(s.dueDate),createdAt:fe(s.createdAt)}));return Ce(r,e)}function tn(t){let e=["id","horseId","horseName","sessionType","date","duration","exercises","performanceRating","notes","weatherConditions","completedAt","createdAt"],r=t.map(s=>({...s,date:Pe(s.date),completedAt:fe(s.completedAt),createdAt:fe(s.createdAt)}));return Ce(r,e)}function rn(t){let e=["id","horseId","horseName","competitionName","date","venue","discipline","level","placement","score","notes","createdAt"],r=t.map(s=>({...s,date:Pe(s.date),createdAt:fe(s.createdAt)}));return Ce(r,e)}function nn(t){let e=["id","horseId","horseName","feedType","brandName","quantity","unit","cost","purchaseDate","supplierName","notes","createdAt"],r=t.map(s=>({...s,purchaseDate:Pe(s.purchaseDate),createdAt:fe(s.createdAt)}));return Ce(r,e)}function sn(t){let e=["id","horseId","horseName","fileName","fileSize","fileType","category","description","uploadedAt"],r=t.map(s=>({...s,uploadedAt:fe(s.uploadedAt||s.createdAt)}));return Ce(r,e)}le();re();Ke();import{eq as f,and as W,desc as ce,sql as ie,gte as ps,lte as ms,or as fs,inArray as Be}from"drizzle-orm";var b=S.use(async({ctx:t,next:e})=>{let r=await Z(t.user.id);if(!r)throw new m({code:"UNAUTHORIZED",message:"User not found"});if(r.isSuspended)throw new m({code:"FORBIDDEN",message:"Your account has been suspended. Please contact support."});if(!["trial","active"].includes(r.subscriptionStatus)){if(r.subscriptionStatus==="trial"&&r.trialEndsAt&&new Date(r.trialEndsAt)<new Date)throw new m({code:"FORBIDDEN",message:"Your free trial has expired. Please subscribe to continue."});if(r.subscriptionStatus==="overdue"||r.subscriptionStatus==="expired")throw new m({code:"FORBIDDEN",message:"Your subscription has expired. Please renew to continue."})}return e({ctx:t})}),an=U({system:Yr,auth:U({me:Ee.query(t=>t.ctx.user),logout:Ee.mutation(({ctx:t})=>{let e=it(t.req);return t.res.clearCookie(oe,{...e,maxAge:-1}),{success:!0}})}),adminUnlock:U({getStatus:S.query(async({ctx:t})=>{let e=await ot(t.user.id);return{isUnlocked:e?e.expiresAt>new Date:!1,expiresAt:e?.expiresAt}}),requestUnlock:S.mutation(async({ctx:t})=>{let e=await rr(t.user.id);if(e>=5){let r=await ir(t.user.id);if(r&&r>new Date)throw new m({code:"TOO_MANY_REQUESTS",message:`Too many attempts. Try again after ${r.toISOString()}`})}return{challenge:"Admin mode requires password. Enter password:",attemptsRemaining:Math.max(0,5-e)}}),submitPassword:S.input(n.object({password:n.string()})).mutation(async({ctx:t,input:e})=>{let r=process.env.ADMIN_UNLOCK_PASSWORD||"ashmor12@",s=await nr(t.user.id);if(s>5)throw await or(t.user.id,15),new m({code:"TOO_MANY_REQUESTS",message:"Too many attempts. Account locked for 15 minutes."});if(e.password!==r)throw await q({userId:t.user.id,action:"admin_unlock_failed",entityType:"system",details:JSON.stringify({attempts:s})}),new m({code:"UNAUTHORIZED",message:"Incorrect password"});let o=new Date(Date.now()+1800*1e3);return await er(t.user.id,o),await sr(t.user.id),await q({userId:t.user.id,action:"admin_unlocked",entityType:"system",details:JSON.stringify({expiresAt:o})}),{success:!0,expiresAt:o}}),lock:S.mutation(async({ctx:t})=>(await tr(t.user.id),{success:!0}))}),ai:U({chat:S.input(n.object({messages:n.array(n.object({role:n.enum(["system","user","assistant"]),content:n.string()}))})).mutation(async({ctx:t,input:e})=>{if(e.messages[e.messages.length-1]?.content.toLowerCase().trim()==="show admin"){if(t.user.role!=="admin")return{role:"assistant",content:"You do not have admin privileges."};let o=await ot(t.user.id);return o&&o.expiresAt>new Date?{role:"assistant",content:`Admin mode is already unlocked. Session expires at ${o.expiresAt.toLocaleString()}.`}:{role:"assistant",content:`\u{1F510} **Admin Mode**

Please enter the admin password to unlock admin features.`,metadata:{adminChallenge:!0}}}return{role:"assistant",content:(await Sr({messages:e.messages.map(o=>({role:o.role,content:o.content}))})).choices[0]?.message?.content||"No response"}})}),billing:U({getPricing:Ee.query(()=>y.enableStripe?{enabled:!0,monthly:{amount:ne.monthly.amount,currency:ne.monthly.currency,interval:ne.monthly.interval},yearly:{amount:ne.yearly.amount,currency:ne.yearly.currency,interval:ne.yearly.interval}}:{enabled:!1,message:"Billing is disabled",monthly:null,yearly:null}),createCheckout:S.input(n.object({plan:n.enum(["monthly","yearly"])})).mutation(async({ctx:t,input:e})=>{if(!y.enableStripe)throw new m({code:"PRECONDITION_FAILED",message:"Billing is disabled"});let r=await Z(t.user.id);if(!r)throw new m({code:"NOT_FOUND",message:"User not found"});let s=e.plan==="monthly"?ne.monthly.priceId:ne.yearly.priceId;if(!s)throw new m({code:"INTERNAL_SERVER_ERROR",message:"Stripe price ID not configured"});let o=t.req.protocol||"https",a=t.req.headers.host||"equiprofile.online",d=`${o}://${a}`,h=await dt(r.id,r.email||"",s,`${d}/dashboard?success=true`,`${d}/pricing?cancelled=true`,r.stripeCustomerId||void 0);if(!h)throw new m({code:"INTERNAL_SERVER_ERROR",message:"Failed to create checkout session"});return{url:h.url}}),createPortal:S.mutation(async({ctx:t})=>{if(!y.enableStripe)throw new m({code:"PRECONDITION_FAILED",message:"Billing is disabled"});let e=await Z(t.user.id);if(!e||!e.stripeCustomerId)throw new m({code:"BAD_REQUEST",message:"No active subscription found"});let r=t.req.protocol||"https",s=t.req.headers.host||"equiprofile.online",o=`${r}://${s}`,a=await ct(e.stripeCustomerId,`${o}/dashboard`);if(!a)throw new m({code:"INTERNAL_SERVER_ERROR",message:"Failed to create portal session"});return{url:a}}),getStatus:S.query(async({ctx:t})=>{let e=await Z(t.user.id);return e?{status:e.subscriptionStatus,plan:e.subscriptionPlan,trialEndsAt:e.trialEndsAt,subscriptionEndsAt:e.subscriptionEndsAt,lastPaymentAt:e.lastPaymentAt,hasActiveSubscription:["trial","active"].includes(e.subscriptionStatus)}:null})}),user:U({getProfile:S.query(async({ctx:t})=>await Z(t.user.id)),updateProfile:S.input(n.object({name:n.string().optional(),phone:n.string().optional(),location:n.string().optional(),profileImageUrl:n.string().optional()})).mutation(async({ctx:t,input:e})=>(await G(t.user.id,e),await q({userId:t.user.id,action:"profile_updated",entityType:"user",entityId:t.user.id,details:JSON.stringify(e)}),{success:!0})),getSubscriptionStatus:S.query(async({ctx:t})=>{let e=await Z(t.user.id);return e?{status:e.subscriptionStatus,plan:e.subscriptionPlan,trialEndsAt:e.trialEndsAt,subscriptionEndsAt:e.subscriptionEndsAt,lastPaymentAt:e.lastPaymentAt}:null}),getDashboardStats:b.query(async({ctx:t})=>{let e=await Ue(t.user.id),r=await Ze(t.user.id),s=await Qe(t.user.id,14),o=await nt(t.user.id);return{horseCount:e.length,upcomingSessionCount:r.length,reminderCount:s.length,latestWeather:o}})}),horses:U({list:b.query(async({ctx:t})=>Ue(t.user.id)),get:b.input(n.object({id:n.number()})).query(async({ctx:t,input:e})=>{let r=await Rt(e.id,t.user.id);if(!r)throw new m({code:"NOT_FOUND",message:"Horse not found"});return r}),create:b.input(n.object({name:n.string().min(1),breed:n.string().optional(),age:n.number().optional(),dateOfBirth:n.string().optional(),height:n.number().optional(),weight:n.number().optional(),color:n.string().optional(),gender:n.enum(["stallion","mare","gelding"]).optional(),discipline:n.string().optional(),level:n.string().optional(),registrationNumber:n.string().optional(),microchipNumber:n.string().optional(),notes:n.string().optional(),photoUrl:n.string().optional()})).mutation(async({ctx:t,input:e})=>{let r=await vt({...e,userId:t.user.id,dateOfBirth:e.dateOfBirth?new Date(e.dateOfBirth):void 0});return await q({userId:t.user.id,action:"horse_created",entityType:"horse",entityId:r,details:JSON.stringify({name:e.name})}),{id:r}}),update:b.input(n.object({id:n.number(),name:n.string().optional(),breed:n.string().optional(),age:n.number().optional(),dateOfBirth:n.string().optional(),height:n.number().optional(),weight:n.number().optional(),color:n.string().optional(),gender:n.enum(["stallion","mare","gelding"]).optional(),discipline:n.string().optional(),level:n.string().optional(),registrationNumber:n.string().optional(),microchipNumber:n.string().optional(),notes:n.string().optional(),photoUrl:n.string().optional()})).mutation(async({ctx:t,input:e})=>{let{id:r,dateOfBirth:s,...o}=e;return await xt(r,t.user.id,{...o,dateOfBirth:s?new Date(s):void 0}),await q({userId:t.user.id,action:"horse_updated",entityType:"horse",entityId:r}),{success:!0}}),delete:b.input(n.object({id:n.number()})).mutation(async({ctx:t,input:e})=>(await Tt(e.id,t.user.id),await q({userId:t.user.id,action:"horse_deleted",entityType:"horse",entityId:e.id}),{success:!0})),exportCSV:b.query(async({ctx:t})=>{let e=await Ue(t.user.id),r=Zr(e),s=ge("horses");return{csv:r,filename:s,mimeType:"text/csv"}})}),healthRecords:U({listAll:b.query(async({ctx:t})=>ze(t.user.id)),listByHorse:b.input(n.object({horseId:n.number()})).query(async({ctx:t,input:e})=>_t(e.horseId,t.user.id)),get:b.input(n.object({id:n.number()})).query(async({ctx:t,input:e})=>{let r=await Ut(e.id,t.user.id);if(!r)throw new m({code:"NOT_FOUND",message:"Health record not found"});return r}),create:b.input(n.object({horseId:n.number(),recordType:n.enum(["vaccination","deworming","dental","farrier","veterinary","injury","medication","other"]),title:n.string().min(1),description:n.string().optional(),recordDate:n.string(),nextDueDate:n.string().optional(),vetName:n.string().optional(),vetPhone:n.string().optional(),vetClinic:n.string().optional(),cost:n.number().optional(),documentUrl:n.string().optional(),notes:n.string().optional()})).mutation(async({ctx:t,input:e})=>{let r=await Dt({...e,userId:t.user.id,recordDate:new Date(e.recordDate),nextDueDate:e.nextDueDate?new Date(e.nextDueDate):void 0});return await q({userId:t.user.id,action:"health_record_created",entityType:"health_record",entityId:r}),{id:r}}),update:b.input(n.object({id:n.number(),recordType:n.enum(["vaccination","deworming","dental","farrier","veterinary","injury","medication","other"]).optional(),title:n.string().optional(),description:n.string().optional(),recordDate:n.string().optional(),nextDueDate:n.string().optional(),vetName:n.string().optional(),vetPhone:n.string().optional(),vetClinic:n.string().optional(),cost:n.number().optional(),documentUrl:n.string().optional(),notes:n.string().optional()})).mutation(async({ctx:t,input:e})=>{let{id:r,recordDate:s,nextDueDate:o,...a}=e;return await kt(r,t.user.id,{...a,recordDate:s?new Date(s):void 0,nextDueDate:o?new Date(o):void 0}),{success:!0}}),delete:b.input(n.object({id:n.number()})).mutation(async({ctx:t,input:e})=>(await Ot(e.id,t.user.id),{success:!0})),getReminders:b.input(n.object({days:n.number().default(30)})).query(async({ctx:t,input:e})=>Qe(t.user.id,e.days)),exportCSV:b.query(async({ctx:t})=>{let e=await ze(t.user.id),r=en(e),s=ge("health_records");return{csv:r,filename:s,mimeType:"text/csv"}})}),training:U({listByHorse:b.input(n.object({horseId:n.number()})).query(async({ctx:t,input:e})=>Ct(e.horseId,t.user.id)),listAll:b.query(async({ctx:t})=>Xe(t.user.id)),getUpcoming:b.query(async({ctx:t})=>Ze(t.user.id)),create:b.input(n.object({horseId:n.number(),sessionDate:n.string(),startTime:n.string().optional(),endTime:n.string().optional(),duration:n.number().optional(),sessionType:n.enum(["flatwork","jumping","hacking","lunging","groundwork","competition","lesson","other"]),discipline:n.string().optional(),trainer:n.string().optional(),location:n.string().optional(),goals:n.string().optional(),exercises:n.string().optional(),notes:n.string().optional()})).mutation(async({ctx:t,input:e})=>{let r=await Pt({...e,userId:t.user.id,sessionDate:new Date(e.sessionDate)});return await q({userId:t.user.id,action:"training_session_created",entityType:"training_session",entityId:r}),{id:r}}),update:b.input(n.object({id:n.number(),sessionDate:n.string().optional(),startTime:n.string().optional(),endTime:n.string().optional(),duration:n.number().optional(),sessionType:n.enum(["flatwork","jumping","hacking","lunging","groundwork","competition","lesson","other"]).optional(),discipline:n.string().optional(),trainer:n.string().optional(),location:n.string().optional(),goals:n.string().optional(),exercises:n.string().optional(),notes:n.string().optional(),performance:n.enum(["excellent","good","average","poor"]).optional(),weather:n.string().optional(),temperature:n.number().optional(),isCompleted:n.boolean().optional()})).mutation(async({ctx:t,input:e})=>{let{id:r,sessionDate:s,...o}=e;return await et(r,t.user.id,{...o,sessionDate:s?new Date(s):void 0}),{success:!0}}),delete:b.input(n.object({id:n.number()})).mutation(async({ctx:t,input:e})=>(await Bt(e.id,t.user.id),{success:!0})),complete:b.input(n.object({id:n.number(),performance:n.enum(["excellent","good","average","poor"]).optional(),notes:n.string().optional()})).mutation(async({ctx:t,input:e})=>(await et(e.id,t.user.id,{isCompleted:!0,performance:e.performance,notes:e.notes}),{success:!0})),exportCSV:b.query(async({ctx:t})=>{let e=await Xe(t.user.id),r=tn(e),s=ge("training_sessions");return{csv:r,filename:s,mimeType:"text/csv"}})}),feeding:U({listAll:b.query(async({ctx:t})=>tt(t.user.id)),listByHorse:b.input(n.object({horseId:n.number()})).query(async({ctx:t,input:e})=>Lt(e.horseId,t.user.id)),create:b.input(n.object({horseId:n.number(),feedType:n.string().min(1),brandName:n.string().optional(),quantity:n.string().min(1),unit:n.string().optional(),mealTime:n.enum(["morning","midday","evening","night"]),frequency:n.string().optional(),specialInstructions:n.string().optional()})).mutation(async({ctx:t,input:e})=>({id:await jt({...e,userId:t.user.id})})),update:b.input(n.object({id:n.number(),feedType:n.string().optional(),brandName:n.string().optional(),quantity:n.string().optional(),unit:n.string().optional(),mealTime:n.enum(["morning","midday","evening","night"]).optional(),frequency:n.string().optional(),specialInstructions:n.string().optional(),isActive:n.boolean().optional()})).mutation(async({ctx:t,input:e})=>{let{id:r,...s}=e;return await qt(r,t.user.id,s),{success:!0}}),delete:b.input(n.object({id:n.number()})).mutation(async({ctx:t,input:e})=>(await $t(e.id,t.user.id),{success:!0})),exportCSV:b.query(async({ctx:t})=>{let e=await tt(t.user.id),r=nn(e),s=ge("feeding_plans");return{csv:r,filename:s,mimeType:"text/csv"}})}),documents:U({list:b.query(async({ctx:t})=>rt(t.user.id)),listByHorse:b.input(n.object({horseId:n.number()})).query(async({ctx:t,input:e})=>Ft(e.horseId,t.user.id)),upload:b.input(n.object({fileName:n.string(),fileType:n.string(),fileSize:n.number(),fileData:n.string(),horseId:n.number().optional(),healthRecordId:n.number().optional(),category:n.enum(["health","registration","insurance","competition","other"]).optional(),description:n.string().optional()})).mutation(async({ctx:t,input:e})=>{if(!y.enableUploads)throw new m({code:"PRECONDITION_FAILED",message:"Uploads are disabled"});let r=Buffer.from(e.fileData,"base64"),s=`${t.user.id}/documents/${on()}-${e.fileName}`,{url:o}=await Xr(s,r,e.fileType),a=await Ht({userId:t.user.id,horseId:e.horseId,healthRecordId:e.healthRecordId,fileName:e.fileName,fileType:e.fileType,fileSize:e.fileSize,fileUrl:o,fileKey:s,category:e.category,description:e.description});return await q({userId:t.user.id,action:"document_uploaded",entityType:"document",entityId:a,details:JSON.stringify({fileName:e.fileName})}),{id:a,url:o}}),delete:b.input(n.object({id:n.number()})).mutation(async({ctx:t,input:e})=>(await Mt(e.id,t.user.id),{success:!0})),exportCSV:b.query(async({ctx:t})=>{let e=await rt(t.user.id),r=sn(e),s=ge("documents");return{csv:r,filename:s,mimeType:"text/csv"}})}),weather:U({analyze:b.input(n.object({location:n.string(),temperature:n.number(),humidity:n.number(),windSpeed:n.number(),precipitation:n.number().optional(),conditions:n.string(),uvIndex:n.number().optional(),visibility:n.number().optional()})).mutation(async({ctx:t,input:e})=>{let r=`As an equestrian expert, analyze the following weather conditions for horse riding safety and provide a recommendation:

Location: ${e.location}
Temperature: ${e.temperature}\xB0C
Humidity: ${e.humidity}%
Wind Speed: ${e.windSpeed} km/h
Precipitation: ${e.precipitation||0} mm
Conditions: ${e.conditions}
UV Index: ${e.uvIndex||"Unknown"}
Visibility: ${e.visibility||"Unknown"} km

Please provide:
1. A riding recommendation (excellent, good, fair, poor, or not_recommended)
2. A brief explanation of the conditions
3. Any safety precautions riders should take
4. Best time of day to ride if conditions are marginal

Format your response as JSON with keys: recommendation, explanation, precautions, bestTime`,o=(await Sr({messages:[{role:"system",content:"You are an expert equestrian advisor specializing in weather safety for horse riding. Always respond with valid JSON."},{role:"user",content:r}]})).choices[0]?.message?.content,a=typeof o=="string"?o:"",d="fair";try{d=JSON.parse(a).recommendation||"fair"}catch{let h=e.precipitation??0;e.windSpeed>50||h>10?d="not_recommended":e.temperature<0||e.temperature>35?d="poor":e.windSpeed>30||h>5?d="fair":e.temperature>=10&&e.temperature<=25?d="excellent":d="good"}return await Kt({userId:t.user.id,location:e.location,temperature:e.temperature,humidity:e.humidity,windSpeed:e.windSpeed,precipitation:e.precipitation,conditions:e.conditions,uvIndex:e.uvIndex,visibility:e.visibility,ridingRecommendation:d,aiAnalysis:a}),{recommendation:d,analysis:a}}),getLatest:b.query(async({ctx:t})=>nt(t.user.id)),getHistory:b.input(n.object({limit:n.number().default(7)})).query(async({ctx:t,input:e})=>Wt(t.user.id,e.limit))}),admin:U({getUsers:B.query(async()=>Se()),getUserDetails:B.input(n.object({userId:n.number()})).query(async({input:t})=>{let e=await Z(t.userId);if(!e)throw new m({code:"NOT_FOUND",message:"User not found"});let r=await Ue(t.userId),s=await Yt(t.userId,20);return{user:e,horses:r,activity:s}}),suspendUser:B.input(n.object({userId:n.number(),reason:n.string()})).mutation(async({ctx:t,input:e})=>(await It(e.userId,e.reason),await q({userId:t.user.id,action:"user_suspended",entityType:"user",entityId:e.userId,details:JSON.stringify({reason:e.reason})}),{success:!0})),unsuspendUser:B.input(n.object({userId:n.number()})).mutation(async({ctx:t,input:e})=>(await St(e.userId),await q({userId:t.user.id,action:"user_unsuspended",entityType:"user",entityId:e.userId}),{success:!0})),deleteUser:B.input(n.object({userId:n.number()})).mutation(async({ctx:t,input:e})=>(await At(e.userId),await q({userId:t.user.id,action:"user_deleted",entityType:"user",entityId:e.userId}),{success:!0})),updateUserRole:B.input(n.object({userId:n.number(),role:n.enum(["user","admin"])})).mutation(async({ctx:t,input:e})=>(await G(e.userId,{role:e.role}),await q({userId:t.user.id,action:"user_role_updated",entityType:"user",entityId:e.userId,details:JSON.stringify({newRole:e.role})}),{success:!0})),getStats:B.query(async()=>Qt()),getOverdueUsers:B.query(async()=>Et()),getExpiredTrials:B.query(async()=>Nt()),getActivityLogs:B.input(n.object({limit:n.number().default(100)})).query(async({input:t})=>Gt(t.limit)),getSettings:B.query(async()=>Jt()),updateSetting:B.input(n.object({key:n.string(),value:n.string(),type:n.enum(["string","number","boolean","json"]).optional(),description:n.string().optional()})).mutation(async({ctx:t,input:e})=>(await Vt(e.key,e.value,e.type,e.description,t.user.id),await q({userId:t.user.id,action:"setting_updated",entityType:"setting",details:JSON.stringify({key:e.key})}),{success:!0})),getBackupLogs:B.input(n.object({limit:n.number().default(10)})).query(async({input:t})=>zt(t.limit)),apiKeys:U({list:B.query(async({ctx:t})=>lr(t.user.id)),create:B.input(n.object({name:n.string().min(1).max(100),rateLimit:n.number().min(1).max(1e4).optional(),permissions:n.array(n.string()).optional(),expiresAt:n.string().optional()})).mutation(async({ctx:t,input:e})=>{let r=await ar({userId:t.user.id,name:e.name,rateLimit:e.rateLimit,permissions:e.permissions,expiresAt:e.expiresAt?new Date(e.expiresAt):void 0});return await q({userId:t.user.id,action:"api_key_created",entityType:"api_key",entityId:r.id,details:JSON.stringify({name:e.name})}),r}),revoke:B.input(n.object({id:n.number()})).mutation(async({ctx:t,input:e})=>(await dr(e.id,t.user.id),await q({userId:t.user.id,action:"api_key_revoked",entityType:"api_key",entityId:e.id}),{success:!0})),rotate:B.input(n.object({id:n.number()})).mutation(async({ctx:t,input:e})=>{let r=await cr(e.id,t.user.id);if(!r)throw new m({code:"NOT_FOUND",message:"API key not found"});return await q({userId:t.user.id,action:"api_key_rotated",entityType:"api_key",entityId:e.id}),r}),updateSettings:B.input(n.object({id:n.number(),name:n.string().optional(),rateLimit:n.number().optional(),permissions:n.array(n.string()).optional(),isActive:n.boolean().optional()})).mutation(async({ctx:t,input:e})=>{let{id:r,...s}=e;return await ur(r,t.user.id,s),await q({userId:t.user.id,action:"api_key_updated",entityType:"api_key",entityId:r}),{success:!0}})}),getEnvHealth:B.query(()=>{let t=[{name:"DATABASE_URL",status:!!process.env.DATABASE_URL,critical:!0,conditional:!1},{name:"JWT_SECRET",status:!!process.env.JWT_SECRET,critical:!0,conditional:!1},{name:"ADMIN_UNLOCK_PASSWORD",status:!!process.env.ADMIN_UNLOCK_PASSWORD,critical:!0,conditional:!1},{name:"STRIPE_SECRET_KEY",status:!!process.env.STRIPE_SECRET_KEY,critical:y.enableStripe,conditional:!0,requiredWhen:"ENABLE_STRIPE=true"},{name:"STRIPE_WEBHOOK_SECRET",status:!!process.env.STRIPE_WEBHOOK_SECRET,critical:y.enableStripe,conditional:!0,requiredWhen:"ENABLE_STRIPE=true"},{name:"BUILT_IN_FORGE_API_URL",status:!!process.env.BUILT_IN_FORGE_API_URL,critical:y.enableUploads,conditional:!0,requiredWhen:"ENABLE_UPLOADS=true"},{name:"BUILT_IN_FORGE_API_KEY",status:!!process.env.BUILT_IN_FORGE_API_KEY,critical:y.enableUploads,conditional:!0,requiredWhen:"ENABLE_UPLOADS=true"},{name:"AWS_ACCESS_KEY_ID",status:!!process.env.AWS_ACCESS_KEY_ID,critical:!1,conditional:!1},{name:"AWS_SECRET_ACCESS_KEY",status:!!process.env.AWS_SECRET_ACCESS_KEY,critical:!1,conditional:!1},{name:"AWS_S3_BUCKET",status:!!process.env.AWS_S3_BUCKET,critical:!1,conditional:!1},{name:"OPENAI_API_KEY",status:!!process.env.OPENAI_API_KEY,critical:!1,conditional:!1},{name:"SMTP_HOST",status:!!process.env.SMTP_HOST,critical:!1,conditional:!1}];return{healthy:t.filter(r=>r.critical).every(r=>r.status),checks:t,featureFlags:{enableStripe:y.enableStripe,enableUploads:y.enableUploads},environment:process.env.NODE_ENV||"development",timestamp:new Date().toISOString()}})}),stables:U({create:b.input(n.object({name:n.string().min(1).max(200),description:n.string().optional(),location:n.string().optional(),logo:n.string().optional(),primaryColor:n.string().optional(),secondaryColor:n.string().optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new m({code:"INTERNAL_SERVER_ERROR",message:"Database not available"});let s=await r.insert(me).values({...e,ownerId:t.user.id});return await r.insert($).values({stableId:s[0].insertId,userId:t.user.id,role:"owner"}),{id:s[0].insertId}}),list:S.query(async({ctx:t})=>{let e=await l();if(!e)return[];let r=await e.select().from($).where(f($.userId,t.user.id));if(r.length===0)return[];let s=r.map(o=>o.stableId);return e.select().from(me).where(W(ie`id IN (${s.join(",")})`,f(me.isActive,!0)))}),getById:S.input(n.object({id:n.number()})).query(async({ctx:t,input:e})=>{let r=await l();if(!r)return null;if((await r.select().from($).where(W(f($.stableId,e.id),f($.userId,t.user.id))).limit(1)).length===0)throw new m({code:"FORBIDDEN",message:"Access denied"});return(await r.select().from(me).where(f(me.id,e.id)).limit(1))[0]||null}),update:b.input(n.object({id:n.number(),name:n.string().optional(),description:n.string().optional(),location:n.string().optional(),logo:n.string().optional(),primaryColor:n.string().optional(),secondaryColor:n.string().optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new m({code:"INTERNAL_SERVER_ERROR"});let s=await r.select().from($).where(W(f($.stableId,e.id),f($.userId,t.user.id))).limit(1);if(s.length===0||!["owner","admin"].includes(s[0].role))throw new m({code:"FORBIDDEN"});let{id:o,...a}=e;return await r.update(me).set({...a,updatedAt:new Date}).where(f(me.id,o)),{success:!0}}),inviteMember:b.input(n.object({stableId:n.number(),email:n.string().email(),role:n.enum(["admin","trainer","member","viewer"])})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new m({code:"INTERNAL_SERVER_ERROR"});let s=await r.select().from($).where(W(f($.stableId,e.stableId),f($.userId,t.user.id))).limit(1);if(s.length===0||!["owner","admin"].includes(s[0].role))throw new m({code:"FORBIDDEN"});let o=on(32),a=new Date;return a.setDate(a.getDate()+7),await r.insert(Tr).values({stableId:e.stableId,invitedByUserId:t.user.id,email:e.email,role:e.role,token:o,expiresAt:a}),{token:o,expiresAt:a}}),getMembers:S.input(n.object({stableId:n.number()})).query(async({ctx:t,input:e})=>{let r=await l();if(!r)return[];if((await r.select().from($).where(W(f($.stableId,e.stableId),f($.userId,t.user.id))).limit(1)).length===0)throw new m({code:"FORBIDDEN"});return r.select().from($).where(W(f($.stableId,e.stableId),f($.isActive,!0)))})}),messages:U({getThreads:S.input(n.object({stableId:n.number()})).query(async({ctx:t,input:e})=>{let r=await l();return r?r.select().from(De).where(W(f(De.stableId,e.stableId),f(De.isActive,!0))).orderBy(ce(De.updatedAt)):[]}),getMessages:S.input(n.object({threadId:n.number(),limit:n.number().default(50)})).query(async({ctx:t,input:e})=>{let r=await l();return r?r.select().from(je).where(f(je.threadId,e.threadId)).orderBy(ce(je.createdAt)).limit(e.limit):[]}),sendMessage:S.input(n.object({threadId:n.number(),content:n.string().min(1),attachments:n.array(n.string()).optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new m({code:"INTERNAL_SERVER_ERROR"});return{id:(await r.insert(je).values({threadId:e.threadId,senderId:t.user.id,content:e.content,attachments:e.attachments?JSON.stringify(e.attachments):null}))[0].insertId}}),createThread:S.input(n.object({stableId:n.number(),title:n.string().optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new m({code:"INTERNAL_SERVER_ERROR"});return{id:(await r.insert(De).values({stableId:e.stableId,title:e.title}))[0].insertId}})}),analytics:U({getTrainingStats:S.input(n.object({horseId:n.number().optional(),startDate:n.string().optional(),endDate:n.string().optional()})).query(async({ctx:t,input:e})=>{let r=await l();if(!r)return null;let s=r.select({totalSessions:ie`COUNT(*)`,completedSessions:ie`SUM(CASE WHEN isCompleted = 1 THEN 1 ELSE 0 END)`,totalDuration:ie`SUM(duration)`,avgPerformance:ie`AVG(CASE 
            WHEN performance = 'excellent' THEN 4
            WHEN performance = 'good' THEN 3
            WHEN performance = 'average' THEN 2
            WHEN performance = 'poor' THEN 1
            ELSE 0 END)`}).from(x).where(f(x.userId,t.user.id));return e.horseId&&(s=s.where(f(x.horseId,e.horseId))),(await s)[0]||null}),getHealthStats:S.input(n.object({horseId:n.number().optional()})).query(async({ctx:t,input:e})=>{let r=await l();return r&&(await r.select({totalRecords:ie`COUNT(*)`,upcomingReminders:ie`SUM(CASE WHEN nextDueDate >= CURDATE() THEN 1 ELSE 0 END)`,overdueReminders:ie`SUM(CASE WHEN nextDueDate < CURDATE() THEN 1 ELSE 0 END)`}).from(E).where(f(E.userId,t.user.id)))[0]||null}),getCostAnalysis:S.input(n.object({horseId:n.number().optional(),startDate:n.string().optional(),endDate:n.string().optional()})).query(async({ctx:t,input:e})=>{let r=await l();if(!r)return null;let s=await r.select({totalCost:ie`SUM(costPerUnit)`}).from(yt).where(f(yt.userId,t.user.id)),o=await r.select({totalCost:ie`SUM(cost)`}).from(E).where(f(E.userId,t.user.id));return{feedCosts:s[0]?.totalCost||0,healthCosts:o[0]?.totalCost||0,totalCosts:(s[0]?.totalCost||0)+(o[0]?.totalCost||0)}})}),reports:U({generate:b.input(n.object({reportType:n.enum(["monthly_summary","health_report","training_progress","cost_analysis","competition_summary"]),horseId:n.number().optional(),stableId:n.number().optional(),startDate:n.string().optional(),endDate:n.string().optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new m({code:"INTERNAL_SERVER_ERROR"});let s={};return{id:(await r.insert(Le).values({userId:t.user.id,stableId:e.stableId,horseId:e.horseId,reportType:e.reportType,title:`${e.reportType.replace("_"," ")} Report`,reportData:JSON.stringify(s)}))[0].insertId}}),list:S.input(n.object({limit:n.number().default(20)})).query(async({ctx:t,input:e})=>{let r=await l();return r?r.select().from(Le).where(f(Le.userId,t.user.id)).orderBy(ce(Le.generatedAt)).limit(e.limit):[]}),scheduleReport:b.input(n.object({reportType:n.enum(["monthly_summary","health_report","training_progress","cost_analysis","competition_summary"]),frequency:n.enum(["daily","weekly","monthly","quarterly"]),recipients:n.array(n.string().email()),stableId:n.number().optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new m({code:"INTERNAL_SERVER_ERROR"});return{id:(await r.insert(_r).values({userId:t.user.id,stableId:e.stableId,reportType:e.reportType,frequency:e.frequency,recipients:JSON.stringify(e.recipients),nextRunAt:new Date}))[0].insertId}})}),calendar:U({getEvents:S.input(n.object({startDate:n.string(),endDate:n.string(),stableId:n.number().optional()})).query(async({ctx:t,input:e})=>{let r=await l();return r?r.select().from(X).where(W(f(X.userId,t.user.id),ps(X.startDate,new Date(e.startDate)),ms(X.startDate,new Date(e.endDate)))).orderBy(X.startDate):[]}),createEvent:b.input(n.object({title:n.string().min(1).max(200),description:n.string().optional(),eventType:n.enum(["training","competition","veterinary","farrier","lesson","meeting","other"]),startDate:n.string(),endDate:n.string().optional(),horseId:n.number().optional(),stableId:n.number().optional(),location:n.string().optional(),isAllDay:n.boolean().default(!1),color:n.string().optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new m({code:"INTERNAL_SERVER_ERROR"});return{id:(await r.insert(X).values({...e,userId:t.user.id,startDate:new Date(e.startDate),endDate:e.endDate?new Date(e.endDate):null}))[0].insertId}}),updateEvent:b.input(n.object({id:n.number(),title:n.string().optional(),description:n.string().optional(),startDate:n.string().optional(),endDate:n.string().optional(),isCompleted:n.boolean().optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new m({code:"INTERNAL_SERVER_ERROR"});let{id:s,...o}=e;return await r.update(X).set({...o,startDate:o.startDate?new Date(o.startDate):void 0,endDate:o.endDate?new Date(o.endDate):void 0,updatedAt:new Date}).where(W(f(X.id,s),f(X.userId,t.user.id))),{success:!0}}),deleteEvent:b.input(n.object({id:n.number()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new m({code:"INTERNAL_SERVER_ERROR"});return await r.delete(X).where(W(f(X.id,e.id),f(X.userId,t.user.id))),{success:!0}})}),competitions:U({create:b.input(n.object({horseId:n.number(),competitionName:n.string().min(1).max(200),venue:n.string().optional(),date:n.string(),discipline:n.string().optional(),level:n.string().optional(),class:n.string().optional(),placement:n.string().optional(),score:n.string().optional(),notes:n.string().optional(),cost:n.number().optional(),winnings:n.number().optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new m({code:"INTERNAL_SERVER_ERROR"});return{id:(await r.insert(Y).values({...e,userId:t.user.id,date:new Date(e.date)}))[0].insertId}}),list:S.input(n.object({horseId:n.number().optional()})).query(async({ctx:t,input:e})=>{let r=await l();return r?e.horseId?r.getCompetitionsByHorseId(e.horseId,t.user.id):r.getCompetitionsByUserId(t.user.id):[]}),exportCSV:b.query(async({ctx:t})=>{let e=await l();if(!e)throw new m({code:"INTERNAL_SERVER_ERROR"});let r=await e.getCompetitionsByUserId(t.user.id),s=rn(r),o=ge("competitions");return{csv:s,filename:o,mimeType:"text/csv"}})}),trainingPrograms:U({listTemplates:S.query(async({ctx:t})=>{let e=await l();return e?e.select().from(j).where(fs(f(j.userId,t.user.id),f(j.isPublic,!0))).orderBy(ce(j.createdAt)):[]}),createTemplate:b.input(n.object({name:n.string().min(1).max(200),description:n.string().optional(),duration:n.number().optional(),discipline:n.string().optional(),level:n.string().optional(),goals:n.string().optional(),programData:n.string(),isPublic:n.boolean().default(!1)})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new m({code:"INTERNAL_SERVER_ERROR"});return{id:(await r.insert(j).values({...e,userId:t.user.id}))[0].insertId}}),getTemplate:S.input(n.object({id:n.number()})).query(async({ctx:t,input:e})=>{let r=await l();if(!r)return null;let s=await r.select().from(j).where(f(j.id,e.id)).limit(1);if(s.length===0)return null;let o=s[0];return o.userId!==t.user.id&&!o.isPublic?null:o}),updateTemplate:b.input(n.object({id:n.number(),name:n.string().min(1).max(200).optional(),description:n.string().optional(),duration:n.number().optional(),discipline:n.string().optional(),level:n.string().optional(),goals:n.string().optional(),programData:n.string().optional(),isPublic:n.boolean().optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new m({code:"INTERNAL_SERVER_ERROR"});let{id:s,...o}=e,a=await r.select().from(j).where(f(j.id,s)).limit(1);if(a.length===0||a[0].userId!==t.user.id)throw new m({code:"FORBIDDEN"});return await r.update(j).set(o).where(f(j.id,s)),{success:!0}}),deleteTemplate:b.input(n.object({id:n.number()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new m({code:"INTERNAL_SERVER_ERROR"});let s=await r.select().from(j).where(f(j.id,e.id)).limit(1);if(s.length===0||s[0].userId!==t.user.id)throw new m({code:"FORBIDDEN"});return await r.delete(j).where(f(j.id,e.id)),{success:!0}}),duplicateTemplate:b.input(n.object({id:n.number()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new m({code:"INTERNAL_SERVER_ERROR"});let s=await r.select().from(j).where(f(j.id,e.id)).limit(1);if(s.length===0)throw new m({code:"NOT_FOUND"});let o=s[0];if(o.userId!==t.user.id&&!o.isPublic)throw new m({code:"FORBIDDEN"});return{id:(await r.insert(j).values({name:`${o.name} (Copy)`,description:o.description,duration:o.duration,discipline:o.discipline,level:o.level,goals:o.goals,programData:o.programData,isPublic:!1,userId:t.user.id}))[0].insertId}}),applyTemplate:b.input(n.object({templateId:n.number(),horseId:n.number(),startDate:n.string()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new m({code:"INTERNAL_SERVER_ERROR"});let s=await r.select().from(j).where(f(j.id,e.templateId)).limit(1);if(s.length===0)throw new m({code:"NOT_FOUND"});return{id:(await r.insert(Dr).values({horseId:e.horseId,userId:t.user.id,templateId:e.templateId,name:s[0].name,startDate:new Date(e.startDate),programData:s[0].programData}))[0].insertId}})}),breeding:U({createRecord:b.input(n.object({mareId:n.number(),stallionId:n.number().optional(),stallionName:n.string().optional(),breedingDate:n.string(),method:n.enum(["natural","artificial","embryo_transfer"]),veterinarianName:n.string().optional(),cost:n.number().optional(),notes:n.string().optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new m({code:"INTERNAL_SERVER_ERROR"});return{id:(await r.insert(T).values({...e,breedingDate:new Date(e.breedingDate)}))[0].insertId}}),list:S.input(n.object({mareId:n.number().optional()})).query(async({ctx:t,input:e})=>{let r=await l();if(!r)return[];let o=(await r.select({id:horses.id}).from(horses).where(f(horses.userId,t.user.id))).map(d=>d.id);if(o.length===0)return[];let a=r.select().from(T).where(Be(T.mareId,o));return e.mareId&&(a=r.select().from(T).where(W(Be(T.mareId,o),f(T.mareId,e.mareId)))),a.orderBy(ce(T.breedingDate))}),get:S.input(n.object({id:n.number()})).query(async({ctx:t,input:e})=>{let r=await l();if(!r)return null;let o=(await r.select({id:horses.id}).from(horses).where(f(horses.userId,t.user.id))).map(d=>d.id),a=await r.select().from(T).where(W(f(T.id,e.id),Be(T.mareId,o))).limit(1);return a.length>0?a[0]:null}),update:b.input(n.object({id:n.number(),stallionName:n.string().optional(),breedingDate:n.string().optional(),method:n.enum(["natural","artificial","embryo_transfer"]).optional(),veterinarianName:n.string().optional(),cost:n.number().optional(),notes:n.string().optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new m({code:"INTERNAL_SERVER_ERROR"});let{id:s,...o}=e,d=(await r.select({id:horses.id}).from(horses).where(f(horses.userId,t.user.id))).map(I=>I.id);if((await r.select().from(T).where(W(f(T.id,s),Be(T.mareId,d))).limit(1)).length===0)throw new m({code:"FORBIDDEN"});let g={...o};return o.breedingDate&&(g.breedingDate=new Date(o.breedingDate)),await r.update(T).set(g).where(f(T.id,s)),{success:!0}}),delete:b.input(n.object({id:n.number()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new m({code:"INTERNAL_SERVER_ERROR"});let o=(await r.select({id:horses.id}).from(horses).where(f(horses.userId,t.user.id))).map(d=>d.id);if((await r.select().from(T).where(W(f(T.id,e.id),Be(T.mareId,o))).limit(1)).length===0)throw new m({code:"FORBIDDEN"});return await r.delete(T).where(f(T.id,e.id)),{success:!0}}),confirmPregnancy:b.input(n.object({id:n.number(),confirmed:n.boolean(),confirmationDate:n.string().optional(),dueDate:n.string().optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new m({code:"INTERNAL_SERVER_ERROR"});let o=(await r.select({id:horses.id}).from(horses).where(f(horses.userId,t.user.id))).map(h=>h.id);if((await r.select().from(T).where(W(f(T.id,e.id),Be(T.mareId,o))).limit(1)).length===0)throw new m({code:"FORBIDDEN"});let d={pregnancyConfirmed:e.confirmed};return e.confirmationDate&&(d.confirmationDate=new Date(e.confirmationDate)),e.dueDate&&(d.dueDate=new Date(e.dueDate)),await r.update(T).set(d).where(f(T.id,e.id)),{success:!0}}),addFoal:b.input(n.object({breedingId:n.number(),birthDate:n.string(),gender:n.enum(["colt","filly"]),name:n.string().optional(),color:n.string().optional(),birthWeight:n.number().optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new m({code:"INTERNAL_SERVER_ERROR"});return{id:(await r.insert(be).values({...e,birthDate:new Date(e.birthDate)}))[0].insertId}}),listFoals:S.input(n.object({breedingId:n.number().optional()})).query(async({ctx:t,input:e})=>{let r=await l();return r?e.breedingId?r.select().from(be).where(f(be.breedingId,e.breedingId)).orderBy(ce(be.birthDate)):r.select().from(be).orderBy(ce(be.birthDate)):[]}),exportCSV:b.query(async({ctx:t})=>{let e=await l();if(!e)throw new m({code:"INTERNAL_SERVER_ERROR"});let r=await e.select().from(T).where(f(T.userId,t.user.id)).orderBy(ce(T.createdAt)),s=["id","mareId","stallionName","breedingDate","method","cost","pregnancyConfirmed","dueDate","notes"],o=r.map(h=>({id:h.id,mareId:h.mareId,stallionName:h.stallionName||"N/A",breedingDate:h.breedingDate?new Date(h.breedingDate).toISOString().split("T")[0]:"",method:h.method,cost:h.cost||0,pregnancyConfirmed:h.pregnancyConfirmed?"Yes":"No",dueDate:h.dueDate?new Date(h.dueDate).toISOString().split("T")[0]:"",notes:h.notes||""})),a=o.length>0?[s.join(","),...o.map(h=>s.map(g=>h[g]).join(","))].join(`
`):s.join(","),d=ge("breeding_records");return{csv:a,filename:d,mimeType:"text/csv"}})}),trainerAvailability:U({create:S.input(n.object({dayOfWeek:n.number().min(0).max(6),startTime:n.string().regex(/^\d{2}:\d{2}$/),endTime:n.string().regex(/^\d{2}:\d{2}$/)})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new m({code:"INTERNAL_SERVER_ERROR"});return{id:(await r.insert(z).values({trainerId:t.user.id,dayOfWeek:e.dayOfWeek,startTime:e.startTime,endTime:e.endTime,isActive:!0}))[0].insertId}}),list:S.query(async({ctx:t})=>{let e=await l();return e?e.select().from(z).where(W(f(z.trainerId,t.user.id),f(z.isActive,!0))).orderBy(z.dayOfWeek,z.startTime):[]}),update:S.input(n.object({id:n.number(),dayOfWeek:n.number().min(0).max(6).optional(),startTime:n.string().regex(/^\d{2}:\d{2}$/).optional(),endTime:n.string().regex(/^\d{2}:\d{2}$/).optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new m({code:"INTERNAL_SERVER_ERROR"});let s=await r.select().from(z).where(f(z.id,e.id)).limit(1);if(!s.length||s[0].trainerId!==t.user.id)throw new m({code:"NOT_FOUND"});let o={};return e.dayOfWeek!==void 0&&(o.dayOfWeek=e.dayOfWeek),e.startTime&&(o.startTime=e.startTime),e.endTime&&(o.endTime=e.endTime),await r.update(z).set(o).where(f(z.id,e.id)),{success:!0}}),delete:S.input(n.object({id:n.number()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new m({code:"INTERNAL_SERVER_ERROR"});let s=await r.select().from(z).where(f(z.id,e.id)).limit(1);if(!s.length||s[0].trainerId!==t.user.id)throw new m({code:"NOT_FOUND"});return await r.update(z).set({isActive:!1}).where(f(z.id,e.id)),{success:!0}})}),lessonBookings:U({create:S.input(n.object({trainerId:n.number(),horseId:n.number().optional(),lessonDate:n.string(),duration:n.number(),lessonType:n.string().optional(),location:n.string().optional(),fee:n.number().optional(),notes:n.string().optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new m({code:"INTERNAL_SERVER_ERROR"});return{id:(await r.insert(P).values({trainerId:e.trainerId,clientId:t.user.id,horseId:e.horseId,lessonDate:new Date(e.lessonDate),duration:e.duration,lessonType:e.lessonType,location:e.location,status:"scheduled",fee:e.fee,paid:!1,notes:e.notes}))[0].insertId}}),list:S.input(n.object({asTrainer:n.boolean().optional(),status:n.enum(["scheduled","completed","cancelled","no_show"]).optional()})).query(async({ctx:t,input:e})=>{let r=await l();if(!r)return[];let s=[];return e.asTrainer?s.push(f(P.trainerId,t.user.id)):s.push(f(P.clientId,t.user.id)),e.status&&s.push(f(P.status,e.status)),r.select().from(P).where(W(...s)).orderBy(ce(P.lessonDate))}),get:S.input(n.object({id:n.number()})).query(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new m({code:"NOT_FOUND"});let s=await r.select().from(P).where(f(P.id,e.id)).limit(1);if(!s.length)throw new m({code:"NOT_FOUND"});let o=s[0];if(o.trainerId!==t.user.id&&o.clientId!==t.user.id)throw new m({code:"FORBIDDEN"});return o}),update:S.input(n.object({id:n.number(),lessonDate:n.string().optional(),duration:n.number().optional(),lessonType:n.string().optional(),location:n.string().optional(),status:n.enum(["scheduled","completed","cancelled","no_show"]).optional(),fee:n.number().optional(),paid:n.boolean().optional(),notes:n.string().optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new m({code:"INTERNAL_SERVER_ERROR"});let s=await r.select().from(P).where(f(P.id,e.id)).limit(1);if(!s.length)throw new m({code:"NOT_FOUND"});let o=s[0];if(o.trainerId!==t.user.id&&o.clientId!==t.user.id)throw new m({code:"FORBIDDEN"});let a={};return e.lessonDate&&(a.lessonDate=new Date(e.lessonDate)),e.duration&&(a.duration=e.duration),e.lessonType&&(a.lessonType=e.lessonType),e.location&&(a.location=e.location),e.status&&(a.status=e.status),e.fee!==void 0&&(a.fee=e.fee),e.paid!==void 0&&(a.paid=e.paid),e.notes&&(a.notes=e.notes),await r.update(P).set(a).where(f(P.id,e.id)),{success:!0}}),delete:S.input(n.object({id:n.number()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new m({code:"INTERNAL_SERVER_ERROR"});let s=await r.select().from(P).where(f(P.id,e.id)).limit(1);if(!s.length)throw new m({code:"NOT_FOUND"});let o=s[0];if(o.trainerId!==t.user.id&&o.clientId!==t.user.id)throw new m({code:"FORBIDDEN"});return await r.delete(P).where(f(P.id,e.id)),{success:!0}}),markCompleted:S.input(n.object({id:n.number()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new m({code:"INTERNAL_SERVER_ERROR"});let s=await r.select().from(P).where(f(P.id,e.id)).limit(1);if(!s.length)throw new m({code:"NOT_FOUND"});if(s[0].trainerId!==t.user.id)throw new m({code:"FORBIDDEN"});return await r.update(P).set({status:"completed"}).where(f(P.id,e.id)),{success:!0}}),markCancelled:S.input(n.object({id:n.number()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new m({code:"INTERNAL_SERVER_ERROR"});let s=await r.select().from(P).where(f(P.id,e.id)).limit(1);if(!s.length)throw new m({code:"NOT_FOUND"});let o=s[0];if(o.trainerId!==t.user.id&&o.clientId!==t.user.id)throw new m({code:"FORBIDDEN"});return await r.update(P).set({status:"cancelled"}).where(f(P.id,e.id)),{success:!0}})})});le();Ke();import{Router as gs}from"express";import{eq as ye,desc as pt}from"drizzle-orm";var he=gs();async function ys(t,e,r){let s=t.headers.authorization;if(!s||!s.startsWith("Bearer "))return e.status(401).json({error:"Missing or invalid authorization header"});if(!s.substring(7))return e.status(401).json({error:"API key is required"});try{if(!await l())return e.status(500).json({error:"Database connection failed"});t.apiUserId=1,r()}catch(a){return console.error("API key verification error:",a),e.status(500).json({error:"Internal server error"})}}he.use(ys);he.get("/horses",async(t,e)=>{try{let r=t.apiUserId,s=await l();if(!s)return e.status(500).json({error:"Database connection failed"});let o=await s.select().from(D).where(ye(D.userId,r)).orderBy(pt(D.createdAt));e.json({success:!0,data:o,count:o.length})}catch(r){console.error("Error fetching horses:",r),e.status(500).json({error:"Failed to fetch horses"})}});he.get("/horses/:id",async(t,e)=>{try{let r=t.apiUserId,s=parseInt(t.params.id);if(isNaN(s))return e.status(400).json({error:"Invalid horse ID"});let o=await l();if(!o)return e.status(500).json({error:"Database connection failed"});let a=await o.select().from(D).where(ye(D.id,s)).limit(1);if(!a.length)return e.status(404).json({error:"Horse not found"});if(a[0].userId!==r)return e.status(403).json({error:"Access denied"});e.json({success:!0,data:a[0]})}catch(r){console.error("Error fetching horse:",r),e.status(500).json({error:"Failed to fetch horse"})}});he.get("/health-records/:horseId",async(t,e)=>{try{let r=t.apiUserId,s=parseInt(t.params.horseId);if(isNaN(s))return e.status(400).json({error:"Invalid horse ID"});let o=await l();if(!o)return e.status(500).json({error:"Database connection failed"});let a=await o.select().from(D).where(ye(D.id,s)).limit(1);if(!a.length||a[0].userId!==r)return e.status(403).json({error:"Access denied"});let d=await o.select().from(E).where(ye(E.horseId,s)).orderBy(pt(E.recordDate));e.json({success:!0,data:d,count:d.length})}catch(r){console.error("Error fetching health records:",r),e.status(500).json({error:"Failed to fetch health records"})}});he.get("/training-sessions/:horseId",async(t,e)=>{try{let r=t.apiUserId,s=parseInt(t.params.horseId);if(isNaN(s))return e.status(400).json({error:"Invalid horse ID"});let o=await l();if(!o)return e.status(500).json({error:"Database connection failed"});let a=await o.select().from(D).where(ye(D.id,s)).limit(1);if(!a.length||a[0].userId!==r)return e.status(403).json({error:"Access denied"});let d=await o.select().from(x).where(ye(x.horseId,s)).orderBy(pt(x.sessionDate));e.json({success:!0,data:d,count:d.length})}catch(r){console.error("Error fetching training sessions:",r),e.status(500).json({error:"Failed to fetch training sessions"})}});he.get("/competitions/:horseId",async(t,e)=>{try{let r=t.apiUserId,s=parseInt(t.params.horseId);if(isNaN(s))return e.status(400).json({error:"Invalid horse ID"});let o=await l();if(!o)return e.status(500).json({error:"Database connection failed"});let a=await o.select().from(D).where(ye(D.id,s)).limit(1);if(!a.length||a[0].userId!==r)return e.status(403).json({error:"Access denied"});let d=await o.select().from(Y).where(ye(Y.horseId,s)).orderBy(pt(Y.date));e.json({success:!0,data:d,count:d.length})}catch(r){console.error("Error fetching competitions:",r),e.status(500).json({error:"Failed to fetch competitions"})}});function hs(t){if(!t)return!1;if(t.role==="admin"||t.subscriptionStatus==="active")return!0;if(t.subscriptionStatus==="trial"&&t.trialEndsAt){let e=new Date;if(new Date(t.trialEndsAt)>e)return!0}return!1}async function ln(t){let e=null;try{e=await de.authenticateRequest(t.req)}catch{e=null}return{req:t.req,res:t.res,user:e,hasAccess:hs(e)}}import vs from"express";import cn from"fs";import{nanoid as Rs}from"nanoid";import mt from"path";import{createServer as xs}from"vite";import{jsxLocPlugin as ws}from"@builder.io/vite-plugin-jsx-loc";import bs from"@tailwindcss/vite";import Is from"@vitejs/plugin-react";import Ar from"node:fs";import ue from"path";import{defineConfig as Ss}from"vite";import{vitePluginManusRuntime as As}from"vite-plugin-manus-runtime";function Es(){return{name:"inject-service-worker-version",apply:"build",generateBundle(){let t=ue.resolve(import.meta.dirname,"package.json"),r=JSON.parse(Ar.readFileSync(t,"utf-8")).version||"1.0.0",s=ue.resolve(import.meta.dirname,"client/public/service-worker.js");if(Ar.existsSync(s)){let o=Ar.readFileSync(s,"utf-8");o=o.replace(/const CACHE_VERSION = ['"]([^'"]+)['"]/,`const CACHE_VERSION = '${r}'`),this.emitFile({type:"asset",fileName:"service-worker.js",source:o})}}}}var Ns=[Is(),bs(),ws(),As(),Es()],dn=Ss({plugins:Ns,resolve:{alias:{"@":ue.resolve(import.meta.dirname,"client","src"),"@shared":ue.resolve(import.meta.dirname,"shared"),"@assets":ue.resolve(import.meta.dirname,"attached_assets")}},envDir:ue.resolve(import.meta.dirname),root:ue.resolve(import.meta.dirname,"client"),publicDir:ue.resolve(import.meta.dirname,"client","public"),build:{outDir:ue.resolve(import.meta.dirname,"dist/public"),emptyOutDir:!0},server:{host:!0,allowedHosts:[".manuspre.computer",".manus.computer",".manus-asia.computer",".manuscomputer.ai",".manusvm.computer","localhost","127.0.0.1"],fs:{strict:!0,deny:["**/.*"]}}});async function un(t,e){let s=await xs({...dn,configFile:!1,server:{middlewareMode:!0,hmr:{server:e},allowedHosts:!0},appType:"custom"});t.use(s.middlewares),t.use("*",async(o,a,d)=>{let h=o.originalUrl;try{let g=mt.resolve(import.meta.dirname,"../..","client","index.html"),I=await cn.promises.readFile(g,"utf-8");I=I.replace('src="/src/main.tsx"',`src="/src/main.tsx?v=${Rs()}"`);let N=await s.transformIndexHtml(h,I);a.status(200).set({"Content-Type":"text/html"}).end(N)}catch(g){s.ssrFixStacktrace(g),d(g)}})}function pn(t){let e=process.env.NODE_ENV==="development"?mt.resolve(import.meta.dirname,"../..","dist","public"):mt.resolve(import.meta.dirname,"public");cn.existsSync(e)||console.error(`Could not find the build directory: ${e}, make sure to build the client first`),t.use(vs.static(e)),t.use("*",(r,s)=>{s.sendFile(mt.resolve(e,"index.html"))})}le();import{nanoid as ks}from"nanoid";re();import{resolve as Os}from"path";function Ps(t){return new Promise(e=>{let r=Ds.createServer();r.listen(t,()=>{r.close(()=>e(!0))}),r.on("error",()=>e(!1))})}async function Cs(t=3e3){for(let e=t;e<t+20;e++)if(await Ps(e))return e;throw new Error(`No available port found starting from ${t}`)}async function Bs(){let t=ft(),e=Ts(t);t.set("trust proxy",1),console.log("\u2705 Trust proxy enabled for reverse proxy support"),t.use(_s({contentSecurityPolicy:process.env.NODE_ENV==="production"?void 0:!1,crossOriginEmbedderPolicy:!1})),t.use((g,I,N)=>{g.headers["x-request-id"]=g.headers["x-request-id"]||ks(),I.setHeader("X-Request-ID",g.headers["x-request-id"]),N()}),t.use((g,I,N)=>{let H=Date.now();I.on("finish",()=>{let ee=Date.now()-H;console.log(`[${g.headers["x-request-id"]}] ${g.method} ${g.path} ${I.statusCode} ${ee}ms`)}),N()});let r=mn({windowMs:parseInt(process.env.RATE_LIMIT_WINDOW_MS||"900000"),max:parseInt(process.env.RATE_LIMIT_MAX_REQUESTS||"100"),message:"Too many requests from this IP, please try again later.",standardHeaders:!0,legacyHeaders:!1});t.use("/api",r);let s=mn({windowMs:6e4,max:60,message:"Too many health check requests",standardHeaders:!0,legacyHeaders:!1});t.post("/api/webhooks/stripe",ft.raw({type:"application/json"}),async(g,I)=>{let N=He();if(!N)return I.status(500).json({error:"Stripe not configured"});let H=g.headers["stripe-signature"],ee=process.env.STRIPE_WEBHOOK_SECRET;if(!H||!ee)return I.status(400).json({error:"Missing signature or secret"});let L;try{L=N.webhooks.constructEvent(g.body,H,ee)}catch(C){return console.error("[Stripe Webhook] Signature verification failed:",C.message),I.status(400).json({error:`Webhook signature verification failed: ${C.message}`})}if(await Zt(L.id))return console.log(`[Stripe Webhook] Event ${L.id} already processed`),I.json({received:!0,cached:!0});await Xt(L.id,L.type,JSON.stringify(L.data.object));try{switch(L.type){case"checkout.session.completed":{let C=L.data.object,F=parseInt(C.metadata?.userId||"0");if(F&&C.customer&&C.subscription){let Er=(await N.subscriptions.retrieve(C.subscription)).items.data[0]?.price.recurring?.interval==="year"?"yearly":"monthly";await G(F,{stripeCustomerId:C.customer,stripeSubscriptionId:C.subscription,subscriptionStatus:"active",subscriptionPlan:Er,lastPaymentAt:new Date});let Nr=await Z(F);Nr&&Cr(Nr,Er).catch(fn=>console.error("[Stripe Webhook] Failed to send payment email:",fn)),console.log(`[Stripe Webhook] User ${F} subscription activated`)}break}case"customer.subscription.updated":{let C=L.data.object,F=await o(C.id);if(F){let Q="active";C.status==="past_due"&&(Q="overdue"),(C.status==="canceled"||C.status==="unpaid")&&(Q="cancelled"),C.status==="incomplete_expired"&&(Q="expired"),await G(F,{subscriptionStatus:Q,subscriptionEndsAt:C.cancel_at?new Date(C.cancel_at*1e3):null}),console.log(`[Stripe Webhook] User ${F} subscription updated to ${Q}`)}break}case"customer.subscription.deleted":{let C=L.data.object,F=await o(C.id);F&&(await G(F,{subscriptionStatus:"cancelled",subscriptionEndsAt:new Date}),console.log(`[Stripe Webhook] User ${F} subscription cancelled`));break}case"invoice.payment_succeeded":{let F=L.data.object.subscription;if(F){let Q=await o(F);Q&&(await G(Q,{subscriptionStatus:"active",lastPaymentAt:new Date}),console.log(`[Stripe Webhook] User ${Q} payment succeeded`))}break}case"invoice.payment_failed":{let F=L.data.object.subscription;if(F){let Q=await o(F);Q&&(await G(Q,{subscriptionStatus:"overdue"}),console.log(`[Stripe Webhook] User ${Q} payment failed`))}break}default:console.log(`[Stripe Webhook] Unhandled event type: ${L.type}`)}await st(L.id),I.json({received:!0})}catch(C){console.error(`[Stripe Webhook] Error processing event ${L.id}:`,C),await st(L.id,C.message),I.status(500).json({error:"Webhook processing failed"})}});async function o(g){return(await Se()).find(H=>H.stripeSubscriptionId===g)?.id||null}t.use(ft.json({limit:"50mb"})),t.use(ft.urlencoded({limit:"50mb",extended:!0}));let a=null;try{let g=Os(process.cwd(),"package.json"),I=JSON.parse(vr("fs").readFileSync(g,"utf-8")),N="unknown";try{let{execSync:H}=vr("child_process");N=H("git rev-parse HEAD",{encoding:"utf-8",timeout:1e3}).trim().slice(0,7)}catch{}a={version:I.version||"1.0.0",buildId:process.env.BUILD_ID||"dev",commit:N,buildTime:process.env.BUILD_TIME||new Date().toISOString(),nodeVersion:process.version}}catch(g){console.warn("\u26A0\uFE0F  Could not generate build info:",g),a={version:"1.0.0",buildId:"unknown",commit:"unknown",buildTime:new Date().toISOString(),nodeVersion:process.version}}t.get("/healthz",s,(g,I)=>{I.json({ok:!0,timestamp:new Date().toISOString()})}),t.get("/build",s,(g,I)=>{I.json(a)}),t.get("/api/health",async(g,I)=>{let N=!!await l(),H=!!He(),ee=!!(y.oAuthServerUrl&&y.appId),L=process.env.npm_package_version||"1.0.0";I.json({status:"healthy",timestamp:new Date().toISOString(),version:L,services:{database:N,stripe:H,oauth:ee}})}),t.get("/api/oauth/status",(g,I)=>{let N=!!(y.oAuthServerUrl&&y.appId);I.json({configured:N,baseUrl:y.baseUrl,oauthServerUrl:N?y.oAuthServerUrl:null})}),Or(t),t.use("/api/auth",Hr),t.use("/api/billing",Mr),t.post("/api/admin/send-test-email",async(g,I)=>{try{let{to:N}=g.body;if(!N)return I.status(400).json({error:"Email address required"});let H=await jr(N);I.json({success:H,message:H?"Test email sent":"Failed to send email (check SMTP config)"})}catch(N){console.error("[Admin] Test email error:",N),I.status(500).json({error:"Internal server error"})}}),t.use("/api/trpc",Us({router:an,createContext:ln})),t.use("/api/v1",he),process.env.NODE_ENV==="development"?await un(t,e):pn(t);let d=parseInt(process.env.PORT||"3000"),h=await Cs(d);h!==d&&console.log(`Port ${d} is busy, using port ${h} instead`),e.listen(h,()=>{console.log(`Server running on http://localhost:${h}/`)})}Bs().catch(console.error);
